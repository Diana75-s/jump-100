<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>è·³åˆ°ç¬¬100å¥ Â· Chapter 1</title>
  <style>
    :root{
      --bg:#f2f3f6;            /* âœ… æµ…ç°ä¸»èƒŒæ™¯ */
      --ink:rgba(0,0,0,.85);
      --muted:rgba(0,0,0,.55);
      --card:rgba(255,255,255,.92);
      --toast:rgba(255,255,255,.55);
      --shadow:0 10px 30px rgba(0,0,0,.10);
      --radius:18px;
    }
    *{box-sizing:border-box}
    html,body{
      height:100%;margin:0;background:var(--bg);
      font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Helvetica,Arial,"PingFang SC","Noto Sans SC","Microsoft YaHei",sans-serif;
      overflow:hidden;
    }
    #app{position:relative;height:100%;width:100%;overflow:hidden}
    canvas{width:100%;height:100%;display:block;touch-action:none}

    /* âœ… é€‚é…å®‰å…¨åŒº */
    .safePadTop{ padding-top: env(safe-area-inset-top); }
    .safePadBottom{ padding-bottom: env(safe-area-inset-bottom); }

    .hud{
      position:absolute;left:12px;right:12px;top:12px;
      display:flex;gap:10px;align-items:center;justify-content:space-between;
      pointer-events:none;
      padding-top: env(safe-area-inset-top);
      z-index:20;
    }
    .pill{
      pointer-events:auto;display:flex;align-items:center;gap:10px;
      background:var(--card);border-radius:999px;padding:10px 12px;
      box-shadow:var(--shadow);backdrop-filter:blur(8px);
      max-width: 70vw;
    }
    .pill .title{font-weight:750;color:var(--ink);font-size:13px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
    .pill .sub{color:var(--muted);font-size:12px}

    .btn{
      pointer-events:auto;border:0;border-radius:999px;padding:10px 12px;
      background:rgba(255,255,255,.96);box-shadow:var(--shadow);
      color:var(--ink);font-weight:700;cursor:pointer;
      backdrop-filter:blur(8px);
      -webkit-tap-highlight-color: transparent;
    }
    .btn:active{transform:translateY(1px)}
    .btn.small{padding:9px 10px;font-weight:750;font-size:12px}

    #toast{
      position:absolute;left:50%;transform:translateX(-50%);
      bottom: calc(72px + env(safe-area-inset-bottom));
      width:min(720px,calc(100% - 24px));
      background:var(--toast);color:var(--ink);
      border-radius:var(--radius);padding:12px 14px;
      box-shadow:var(--shadow);backdrop-filter:blur(8px);
      display:none;align-items:flex-start;gap:10px;
      z-index:25;
    }
    #toast .who{font-size:12px;font-weight:850;white-space:nowrap;opacity:.9}
    #toast .msg{font-size:14px;line-height:1.35;word-break:break-word}
    #toast .expand{
      margin-left:auto;font-size:12px;color:rgba(0,0,0,.65);
      background:rgba(255,255,255,.65);border:0;border-radius:999px;
      padding:6px 10px;cursor:pointer;
    }

    #drawer{
      position:absolute;left:50%;transform:translateX(-50%);
      bottom: calc(128px + env(safe-area-inset-bottom));
      width:min(720px,calc(100% - 24px));
      background:rgba(255,255,255,.94);color:var(--ink);
      border-radius:22px;padding:14px;box-shadow:var(--shadow);
      display:none;backdrop-filter:blur(10px);
      z-index:26;
    }
    #drawer h3{margin:0 0 6px 0;font-size:14px}
    #drawer .context{
      font-size:13px;line-height:1.5;color:rgba(0,0,0,.78);
      max-height:32vh;overflow:auto;padding-right:6px;
    }
    #drawer .close{margin-top:10px;display:flex;justify-content:flex-end}
    #drawer .close button{
      border:0;border-radius:999px;padding:8px 12px;
      background:rgba(0,0,0,.06);cursor:pointer;font-weight:750;color:var(--ink);
    }

    #modalMask{
      position:absolute;inset:0;background:rgba(0,0,0,.35);
      display:none;align-items:center;justify-content:center;padding:16px;
      z-index:40;
    }
    #modal{
      width:min(840px,100%);max-height:78vh;background:rgba(255,255,255,.96);
      border-radius:24px;box-shadow:var(--shadow);overflow:hidden;
      backdrop-filter:blur(12px);display:flex;flex-direction:column;
    }
    #modal header{
      padding:14px 16px;display:flex;align-items:center;justify-content:space-between;
      border-bottom:1px solid rgba(0,0,0,.06);
    }
    #modal header .left{display:flex;flex-direction:column;gap:2px}
    #modal header .left .h{font-weight:900;color:var(--ink)}
    #modal header .left .s{font-size:12px;color:var(--muted)}
    #modal header button{
      border:0;border-radius:999px;padding:8px 12px;
      background:rgba(0,0,0,.06);cursor:pointer;font-weight:800;
    }
    #modal main{padding:12px 16px;overflow:auto}
    .line{
      padding:10px 12px;border-radius:16px;background:rgba(0,0,0,.03);
      margin-bottom:10px;display:flex;gap:10px;align-items:flex-start;
    }
    .line .idx{font-size:12px;color:var(--muted);width:44px;flex:0 0 auto}
    .line .who{font-weight:900;font-size:12px;width:120px;flex:0 0 auto}
    .line .txt{font-size:13px;line-height:1.5;color:rgba(0,0,0,.82);flex:1 1 auto}

    .hint{
      position:absolute;left:50%;transform:translateX(-50%);
      bottom: calc(16px + env(safe-area-inset-bottom));
      width:min(720px,calc(100% - 24px));
      display:flex;gap:10px;align-items:center;justify-content:space-between;
      pointer-events:none;color:var(--muted);font-size:12px;
      z-index:18;
    }
    .kbd{
      pointer-events:none;display:inline-flex;align-items:center;justify-content:center;
      padding:2px 8px;border-radius:999px;background:rgba(255,255,255,.85);
      box-shadow:0 6px 18px rgba(0,0,0,.06);color:rgba(0,0,0,.7);
      font-weight:800;margin:0 4px;
    }

    /* âœ… è“„åŠ›æ¡ UI */
    #chargeWrap{
      position:absolute;left:50%;transform:translateX(-50%);
      bottom: calc(48px + env(safe-area-inset-bottom));
      width:min(520px,calc(100% - 64px));
      display:none;align-items:center;gap:10px;
      pointer-events:none;z-index:30;
    }
    #chargeWrap .label{
      font-size:12px;color:rgba(0,0,0,.55);font-weight:900;
      background:rgba(255,255,255,.85);
      border-radius:999px;padding:6px 10px;box-shadow:0 6px 18px rgba(0,0,0,.06);
      backdrop-filter:blur(8px);
      white-space:nowrap;
    }
    #chargeWrap .bar{
      flex:1 1 auto;height:10px;border-radius:999px;overflow:hidden;
      background:rgba(0,0,0,.10);
      box-shadow:0 6px 18px rgba(0,0,0,.06);
      backdrop-filter:blur(8px);
    }
    #chargeWrap .bar > i{
      display:block;height:100%;width:0%;
      background:rgba(0,0,0,.72);
      border-radius:999px;
    }

    /* âœ… å¤±è´¥å¼¹æ¡† */
    #failMask{
      position:absolute;inset:0;display:none;align-items:center;justify-content:center;
      background:rgba(0,0,0,.35);backdrop-filter:blur(8px);
      padding:16px;z-index:60;
    }
    #failCard{
      width:min(640px,100%);border-radius:26px;
      background:rgba(255,255,255,.94);
      box-shadow:var(--shadow);padding:18px 16px;
      text-align:center;
    }
    #failCard .t{font-weight:950;font-size:18px;color:var(--ink);letter-spacing:.5px}
    #failCard .s{margin-top:6px;font-size:13px;color:var(--muted);line-height:1.6}
    #failCard .actions{margin-top:14px;display:flex;gap:10px;justify-content:center;flex-wrap:wrap}
    #failCard .actions button{
      border:0;border-radius:999px;padding:10px 16px;cursor:pointer;
      font-weight:900;background:rgba(0,0,0,.06);color:var(--ink);
    }
    #failCard .actions button.primary{background:rgba(0,0,0,.82);color:#fff;}

    /* âœ… ç»ˆç« æ»šåŠ¨å­—å¹•ï¼ˆæµ…ç°èƒŒæ™¯ï¼‰ */
    #creditsMask{
      position:absolute;inset:0;display:none;
      background:rgba(242,243,246,.98);
      z-index:80;
      overflow:hidden;
    }
    #creditsTopBar{
      position:absolute;left:12px;right:12px;top:12px;
      display:flex;gap:10px;align-items:center;justify-content:space-between;
      padding-top: env(safe-area-inset-top);
      z-index:81;
    }
    #creditsTopBar .title{
      background:rgba(255,255,255,.86);
      border-radius:999px;padding:10px 12px;
      box-shadow:var(--shadow);backdrop-filter:blur(10px);
      font-weight:900;color:var(--ink);font-size:13px;
      max-width: 70vw;
      white-space:nowrap;overflow:hidden;text-overflow:ellipsis;
    }
    #creditsInner{
      position:absolute;left:50%;transform:translateX(-50%);
      bottom:-40%;
      width:min(820px, calc(100% - 36px));
      text-align:center;
      color:rgba(0,0,0,.78);
      will-change: transform;
      animation: creditsScroll 26s linear forwards;
      padding-bottom: 24vh;
    }
    #creditsInner .h{
      font-size:18px;font-weight:950;color:rgba(0,0,0,.86);
      letter-spacing:.4px;
      margin-top: 18vh;
    }
    #creditsInner .p{
      margin:14px auto 0;
      max-width: 52ch;
      font-size:14px;line-height:1.9;
      background:rgba(255,255,255,.70);
      border-radius:22px;
      padding:16px 16px;
      box-shadow:0 10px 26px rgba(0,0,0,.08);
      backdrop-filter:blur(10px);
      text-align:left;
      white-space:pre-wrap;
    }
    #creditsInner .sig{
      margin:16px auto 0;
      font-size:13px;color:rgba(0,0,0,.55);
      font-weight:800;
    }
    @keyframes creditsScroll{
      from{ transform:translateX(-50%) translateY(0); }
      to{ transform:translateX(-50%) translateY(-160vh); }
    }

    /* âœ… æ‰‹æœºç«¯æ›´ç´§å‡‘ï¼šHUD å˜æˆä¸¤è¡Œï¼ŒæŒ‰é’®å˜å° */
    @media (max-width: 520px){
      .hud{flex-direction:column;align-items:stretch}
      .pill{max-width:none}
      .hint{font-size:11px}
      #toast .msg{font-size:13px}
      .btn{padding:9px 10px}
      .btn.small{padding:8px 10px}
    }
  </style>
</head>
<body>
<div id="app">
  <canvas id="c"></canvas>

  <!-- âœ… èƒŒæ™¯éŸ³ä¹ï¼ˆæŠŠ bgm.mp3 æ”¾åˆ°ä»“åº“æ ¹ç›®å½•ï¼‰ -->
  <audio id="bgm" src="bgm.mp3" preload="auto" loop></audio>

  <div class="hud">
    <div class="pill">
      <div>
        <div class="title">è·³åˆ°ç¬¬100å¥ Â· Chapter 1</div>
        <div class="sub"><span id="progressText">0/100</span> Â· å·²è§£é” <span id="unlockedText">0</span> æ¡</div>
      </div>
    </div>
    <div style="display:flex; gap:10px; pointer-events:auto; flex-wrap:wrap; justify-content:flex-end; align-items:center;">
  <button class="btn small" id="btnMusic">ğŸ”ˆ éŸ³ä¹ï¼šå…³</button>
  <button class="btn" id="btnBook">ğŸ“œ å›å¿†å†Œ</button>

  <!-- âœ… å¸¸é©»å…¥å£ï¼šChapter 2 -->
 <a class="btn" id="btnGoCh2" href="./chapter2.html"
   style="text-decoration:none; display:inline-flex; align-items:center; font-weight:900; border:1px solid rgba(0,0,0,.10);">
  ğŸ® Chapter 2
</a>


  <button class="btn" id="btnReset">â†º é‡ç½®è¿›åº¦</button>
</div>


  <div id="toast">
    <div class="who" id="toastWho"></div>
    <div class="msg" id="toastMsg"></div>
    <button class="expand" id="toastExpand">å±•å¼€</button>
  </div>

  <div id="drawer">
    <h3 id="drawerTitle">å›å¿†ç‰‡æ®µ</h3>
    <div class="context" id="drawerContext"></div>
    <div class="close"><button id="drawerClose">æ”¶èµ·</button></div>
  </div>

  <div id="modalMask">
    <div id="modal">
      <header>
        <div class="left">
          <div class="h">ğŸ“œ å›å¿†å†Œ</div>
          <div class="s">å·²è§£é”çš„å…³å¡ä¼šè‡ªåŠ¨ä¿å­˜ï¼ˆæœ¬åœ°ä¿å­˜ï¼‰</div>
        </div>
        <button id="btnCloseModal">å…³é—­</button>
      </header>
      <main id="modalList"></main>
    </div>
  </div>

  <!-- âœ… è“„åŠ›æ¡ -->
  <div id="chargeWrap">
    <div class="label">è“„åŠ›</div>
    <div class="bar"><i id="chargeFill"></i></div>
    <div class="label" id="chargePct">0%</div>
  </div>

  <!-- âœ… å¤±è´¥å¼¹æ¡† -->
  <div id="failMask">
    <div id="failCard">
      <div class="t">å¤±è´¥</div>
      <div class="s">æ‰ä¸‹å»äº†â€¦<br/>æ˜¯å¦é‡ç½®ï¼Ÿ</div>
      <div class="actions">
        <button class="primary" id="btnFailYes">æ˜¯ï¼ˆé‡ç½®è¿›åº¦ï¼‰</button>
        <button id="btnFailNo">å¦ï¼ˆç»§ç»­ï¼‰</button>
      </div>
    </div>
  </div>

  <!-- âœ… ç»“å°¾æ»šåŠ¨å­—å¹• -->
  <div id="creditsMask">
    <div id="creditsTopBar">
      <div class="title">Chapter 1 Â· å†™ç»™ä½ çš„è¯</div>
      <div style="display:flex;gap:10px; align-items:center;">
        <a class="btn small" id="btnToChapter2" href="./chapter2.html"
           style="text-decoration:none; display:inline-flex; align-items:center;">
          è¿›å…¥ Chapter 2
        </a>
        <button class="btn small" id="btnCreditsReplay">å†è·‘ä¸€é</button>
        <button class="btn small" id="btnCreditsClose">å…³é—­</button>
      </div>
    </div>

    <div id="creditsInner">
      <div class="h">Chapter 1 Â· END</div>
      <div class="p" id="creditsText"></div>
      <div class="sig">â€”â€” å‘é€è‡ªï¼šè·³åˆ°ç¬¬100å¥</div>
    </div>
  </div>


  <div class="hint">
    <div class="k">æ“ä½œï¼š<span class="kbd">æŒ‰ä½</span>è“„åŠ›ï¼Œ<span class="kbd">æ¾å¼€</span>èµ·è·³ Â· å¤±è´¥ä¼šå¼¹çª—</div>
    <div class="k">å°æŠ€å·§ï¼šæ¯è·³ä¸€æ ¼éƒ½ä¼šå¼¹å‡ºä¸€æ¡å›å¿† ğŸ™‚</div>
  </div>
</div>

<script>
(() => {
  // âœ… èƒŒæ™¯å›¾ï¼ˆæ”¾åœ¨åŒç›®å½•ï¼šbg.jpgï¼‰
  const bgImg = new Image();
  bgImg.src = "./bg.jpg";
  let bgReady = false;
  bgImg.onload = () => { bgReady = true; };

  /***********************
   *  1) 100 æ¡æ–‡æœ¬æ± ï¼ˆä½ è¯´ä½ è‡ªå·±çš„å·²å¤Ÿï¼šè¿™é‡Œä¿ç•™ç»“æ„ï¼Œä¸å¼ºåˆ¶æ”¹ä½ å†…å®¹ï¼‰
   *  âœ… ä½ å¯ä»¥ç›´æ¥æŠŠä½ ä»“åº“é‡Œé‚£ 100 æ¡åŸæ–‡ç²˜å›è¿™é‡Œè¦†ç›–å³å¯
   ***********************/
  const LINES_RAW = [
    { who: "åƒåƒ", text: "æˆ‘é€šè¿‡äº†ä½ çš„æœ‹å‹éªŒè¯è¯·æ±‚" },
    { who: "åƒåƒ", text: "ç°åœ¨æˆ‘ä»¬å¯ä»¥å¼€å§‹èŠå¤©äº†" },
    { who: "åƒåƒ", text: "å…»ç”Ÿç‰ˆï¼Ÿ" },
    { who: "è«æ–¯ç§‘çš„å°çŸ®äºº", text: "å“‡å¡ï¼Œä½ é€šè¿‡é€Ÿåº¦å¥½å¿«" },
    { who: "åƒåƒ", text: "å¿«å—ï¼Œéƒ½è¿‡äº† 6 åˆ†é’Ÿäº†" },
    { who: "è«æ–¯ç§‘çš„å°çŸ®äºº", text: "ä½ å¾®ä¿¡å›å¾—æ¯”ç½‘æ˜“äº‘å¿«å¤šäº†" },
    { who: "åƒåƒ", text: "å› ä¸ºæˆ‘ä¸çœ‹é‚£ä¸ª" },
    { who: "è«æ–¯ç§‘çš„å°çŸ®äºº", text: "ç­‰ä¸€ä¸‹ï¼Œæˆ‘å…ˆçœ‹ç‚¹ä¸œè¥¿" },
    { who: "è«æ–¯ç§‘çš„å°çŸ®äºº", text: "ä»Šå¤©ä¸ä¸Šç­ï¼Ÿ" },
    { who: "åƒåƒ", text: "ä¸Š" },

    { who: "åƒåƒ", text: "æ˜å¤©æ—©ä¸Šå°±å‡ºå‘" },
    { who: "åƒåƒ", text: "å»å¸•åŠ³" },
    { who: "è«æ–¯ç§‘çš„å°çŸ®äºº", text: "æ‰§è¡ŒåŠ›è¿™ä¹ˆå¼º" },
    { who: "è«æ–¯ç§‘çš„å°çŸ®äºº", text: "ä½ ä¼‘å¹´å‡å•¦" },
    { who: "åƒåƒ", text: "æ²¡æœ‰" },
    { who: "åƒåƒ", text: "è¯·å»çš„ï¼Œä½ å¯ä»¥è¿™ä¹ˆç†è§£" },
    { who: "è«æ–¯ç§‘çš„å°çŸ®äºº", text: "é‚£ä¹Ÿå¾ˆå‰å®³äº†" },

    { who: "è«æ–¯ç§‘çš„å°çŸ®äºº", text: "ä¸Šæµ·å†·çš„ä¸‹é›ªäº†" },
    { who: "è«æ–¯ç§‘çš„å°çŸ®äºº", text: "é‚£è¾¹åº”è¯¥å¾ˆæš–å’Œäº†" },
    { who: "åƒåƒ", text: "ç›¸å¯¹æ¥è¯´ç¡®å®æ˜¯" },
    { who: "åƒåƒ", text: "ä¸‹é›ªäº†å—" },
    { who: "åƒåƒ", text: "é‚£ä½ å¾—æ³¨æ„ç‚¹" },
    { who: "åƒåƒ", text: "åˆ«æ„Ÿå†’ï¼Œå†·åˆ°äº†" },
    { who: "åƒåƒ", text: "æˆ´ä¸ªè€³åŒ…" },
    { who: "åƒåƒ", text: "å¤©å¤ªå†·å®¹æ˜“ç”Ÿå†»ç–®" },
    { who: "åƒåƒ", text: "æ‰‹å¥—ä¹Ÿæœ€å¥½æˆ´å¥½" },
    { who: "è«æ–¯ç§‘çš„å°çŸ®äºº", text: "å“ˆå“ˆï¼Œæˆ‘å¯ç‰›äº†" },

    { who: "è«æ–¯ç§‘çš„å°çŸ®äºº", text: "æˆ‘ä¸“é—¨å®šåˆ¶äº†ä¸€å¥—ç¾½ç»’æœ" },
    { who: "è«æ–¯ç§‘çš„å°çŸ®äºº", text: "300g çº¯é¹…ç»’" },
    { who: "è«æ–¯ç§‘çš„å°çŸ®äºº", text: "å®Œå…¨ä¸å†·" },
    { who: "è«æ–¯ç§‘çš„å°çŸ®äºº", text: "ç©¿ä¸Šå»åƒéš”ç»ä¸–ç•Œ" },
    { who: "è«æ–¯ç§‘çš„å°çŸ®äºº", text: "è‚‰çœ¼çœ‹å°±å¾ˆåš" },
    { who: "åƒåƒ", text: "é‚£ç¡®å®æ˜¯æš–å’Œè¿‡å†¬äº†" },
    { who: "åƒåƒ", text: "ä¸å†·å°±è¡Œ" },
    { who: "è«æ–¯ç§‘çš„å°çŸ®äºº", text: "ä½ å’‹å–œæ¬¢ç”¨è¿™äº›å¤æ—©è¡¨æƒ…åŒ…" },
    { who: "åƒåƒ", text: "å¯èƒ½æˆ‘æ˜¯å¤æ—©ä¹‹äºº" },
    { who: "åƒåƒ", text: "æˆ‘æ˜¯æ—§æ—¶ä»£çš„äºº" },

    { who: "åƒåƒ", text: "æ–°æ—¶ä»£æ²¡æœ‰èƒ½è½½åŠ¨æˆ‘çš„èˆ¹" },
    { who: "è«æ–¯ç§‘çš„å°çŸ®äºº", text: "ä½ è¿˜æŒºå¹½é»˜çš„" },
    { who: "è«æ–¯ç§‘çš„å°çŸ®äºº", text: "æ˜å¤©å»å¸•åŠ³æ½œæ°´ï¼Ÿ" },
    { who: "è«æ–¯ç§‘çš„å°çŸ®äºº", text: "æˆ‘æœæœç°åœ¨å»é‚£è¦å‡†å¤‡ä»€ä¹ˆ" },
    { who: "åƒåƒ", text: "ä½ ç«Ÿç„¶çŸ¥é“" },
    { who: "åƒåƒ", text: "éœ€è¦æ—¶é—´" },
    { who: "è«æ–¯ç§‘çš„å°çŸ®äºº", text: "æˆ‘è¿‡å¹´æ‰æœ‰æ—¶é—´å‡ºå»ç©" },
    { who: "è«æ–¯ç§‘çš„å°çŸ®äºº", text: "è¿‡å¹´æœºç¥¨å¾ˆè´µ" },
    { who: "è«æ–¯ç§‘çš„å°çŸ®äºº", text: "å¥½åƒå»å¸•åŠ³éƒ½æŒºè´µ" },
    { who: "è«æ–¯ç§‘çš„å°çŸ®äºº", text: "è½åœ°ç­¾å°±è¡Œå§" },

    { who: "åƒåƒ", text: "è€å®å¾…åœ¨å®¶" },
    { who: "åƒåƒ", text: "å‰æ®µæ—¶é—´å›å»è¿‡äº†" },
    { who: "åƒåƒ", text: "æ”»ç•¥ï¼Ÿ" },
    { who: "åƒåƒ", text: "çœŸæ²¡å•¥æ”»ç•¥å¯è¨€" },
    { who: "è«æ–¯ç§‘çš„å°çŸ®äºº", text: "æ½œæ°´çœŸå¥½" },
    { who: "è«æ–¯ç§‘çš„å°çŸ®äºº", text: "ç©å¾—å¼€å¿ƒ" },
    { who: "è«æ–¯ç§‘çš„å°çŸ®äºº", text: "æ³¨æ„å®‰å…¨" },
    { who: "åƒåƒ", text: "æ”¾å¿ƒå§" },
    { who: "åƒåƒ", text: "æˆ‘åªæ˜¯ç®€å•æµ®æ½œ" },
    { who: "åƒåƒ", text: "ä¹Ÿä¸æ˜¯æ½œæ°´" },

    { who: "è«æ–¯ç§‘çš„å°çŸ®äºº", text: "ä½ ç»å¸¸å»é‚£ç©å—" },
    { who: "åƒåƒ", text: "é‚£æ²¡æœ‰" },
    { who: "åƒåƒ", text: "æˆ‘æ˜¯ç¬¬ä¸€æ¬¡" },
    { who: "åƒåƒ", text: "å¤§å§‘å¨˜ä¸ŠèŠ±è½¿å¤´ä¸€æ¬¡" },
    { who: "è«æ–¯ç§‘çš„å°çŸ®äºº", text: "é‚£æˆ‘å¯ä»¥ç»™ä½ ç‚¹ç»éªŒ" },
    { who: "åƒåƒ", text: "ä»€ä¹ˆç»éªŒ" },
    { who: "åƒåƒ", text: "æå¾—åƒä½ å»è¿‡ä¸€æ ·" },
    { who: "åƒåƒ", text: "æˆ‘æ¥å¬å¬" },
    { who: "è«æ–¯ç§‘çš„å°çŸ®äºº", text: "æˆ‘ä¹‹å‰åœ¨ä»™æœ¬é‚£æµ®æ½œè¿‡" },
    { who: "è«æ–¯ç§‘çš„å°çŸ®äºº", text: "é˜²æ™’çœŸçš„å¾ˆé‡è¦" },

    { who: "è«æ–¯ç§‘çš„å°çŸ®äºº", text: "å¸Œæœ›å¯¹ä½ æœ‰ç‚¹å¸®åŠ©" },
    { who: "åƒåƒ", text: "ä½ æ€ä¹ˆè¿™ä¹ˆå¯çˆ±" },
    { who: "åƒåƒ", text: "æˆ‘å»æŠ¥äº†å›¢" },
    { who: "åƒåƒ", text: "æˆ‘è¿˜æŒºå¼€å¿ƒçš„" },
    { who: "è«æ–¯ç§‘çš„å°çŸ®äºº", text: "å›¢é‡Œçš„ä¸€æ¬¡æ€§å’¬å˜´" },
    { who: "è«æ–¯ç§‘çš„å°çŸ®äºº", text: "å¯ä»¥å¤šå¤‡å‡ ä¸ª" },
    { who: "è«æ–¯ç§‘çš„å°çŸ®äºº", text: "å®¹æ˜“ä¸¢" },
    { who: "è«æ–¯ç§‘çš„å°çŸ®äºº", text: "æˆ‘å¾—å»å¿™äº†" },
    { who: "åƒåƒ", text: "å»å§" },
    { who: "åƒåƒ", text: "æˆ‘ç­‰ä½ " },

    { who: "è«æ–¯ç§‘çš„å°çŸ®äºº", text: "ä¼°è®¡è¦è¢«å¼€äº†" },
    { who: "åƒåƒ", text: "è¯´å•¥å‘¢" },
    { who: "è«æ–¯ç§‘çš„å°çŸ®äºº", text: "ä½ ä¸åšç‚¹å‡†å¤‡å—" },
    { who: "åƒåƒ", text: "è¯¥å¸¦çš„éƒ½æ”¶æ‹¾å¥½äº†" },
    { who: "è«æ–¯ç§‘çš„å°çŸ®äºº", text: "é‚£å°±å¥½" },
    { who: "åƒåƒ", text: "ç¼˜åˆ†å·²å°½å°±ç»“æŸ" },
    { who: "åƒåƒ", text: "ä¸å»æ—§çš„" },
    { who: "åƒåƒ", text: "å“ªæ¥æ–°çš„" },
    { who: "åƒåƒ", text: "ä¸ç„¶æ€ä¹ˆè®¤è¯†æˆ‘" },
    { who: "è«æ–¯ç§‘çš„å°çŸ®äºº", text: "å¥½" },

    { who: "è«æ–¯ç§‘çš„å°çŸ®äºº", text: "å¿«å»å¥èº«å§" },
    { who: "åƒåƒ", text: "ä½ è›®æœ‰æ„æ€çš„" },
    { who: "åƒåƒ", text: "å¾ˆå¼€å¿ƒè®¤è¯†ä½ " },
    { who: "åƒåƒ", text: "å«æˆ‘åƒåƒ" },
    { who: "è«æ–¯ç§‘çš„å°çŸ®äºº", text: "å¤‡æ³¨å—" },
    { who: "åƒåƒ", text: "è¿™æ˜¯æˆ‘å°å" },
    { who: "åƒåƒ", text: "æ€»ä¸èƒ½ æ¯å¤©å°±è¯¶ ä½  è¿™ç§å§" },
    { who: "è«æ–¯ç§‘çš„å°çŸ®äºº", text: "æˆ‘å«ä¸çº¢" },
    { who: "è«æ–¯ç§‘çš„å°çŸ®äºº", text: "è¿™ä¹ˆæš§æ˜§çš„å—" },
    { who: "è«æ–¯ç§‘çš„å°çŸ®äºº", text: "é˜¿ï¼Ÿ" },

    { who: "è«æ–¯ç§‘çš„å°çŸ®äºº", text: "æˆ‘ä»¥ä¸ºå°åæ˜¯å®¶äººå«çš„é‚£ç§" },
    { who: "åƒåƒ", text: "å“ˆå“ˆå“ˆå“ˆ ä¸ä¼šå•Šå°åè€Œå·²,åˆä¸æ˜¯ä»€ä¹ˆæ¯”è¾ƒéšç§çš„ç§°å‘¼" },
    { who: "åƒåƒ", text: "å½“ç„¶ ä½ è¦æ„¿æ„å« æˆ‘ä¹Ÿå¯ä»¥è¯•ä¸€ä¸‹" },
    { who: "è«æ–¯ç§‘çš„å°çŸ®äºº", text: "ä¸‹ç­å•¦ ä¸Šæµ·çœŸçš„å¿«å†·æ­»äº†" },
    { who: "åƒåƒ", text: "å“ˆå“ˆå“ˆå“ˆ ä½ åˆ«ç€å‡‰" },
    { who: "åƒåƒ", text: "ï¼ˆå‘æ¥ä¸€å¼ å¥èº«ç…§ç‰‡ï¼‰" },
    { who: "è«æ–¯ç§‘çš„å°çŸ®äºº", text: "æˆ‘çœ‹çœ‹ æ˜¯ç¡¬æ‹‰å—ï¼Œå¥½ç‰›é€¼ï¼Œæˆ‘å¥½ä¹…éƒ½æ²¡å»è¿‡å¥èº«æˆ¿äº†" },
    { who: "åƒåƒ", text: "æˆ‘æ˜¯å¸¸å®¢ï¼Œä½†å·¥ä½œæ—¥ä¸ä¼šå¤ªä¹…ï¼Œå› ä¸ºä¸€ä¼šäººå°±å¤šäº†" },
  ];

  // âœ… å®‰å…¨ï¼šåªå–å‰ 100 æ¡
  const LINES = LINES_RAW.slice(0, 100);

  /***********************
   *  2) æœ¬åœ°å­˜æ¡£
   ***********************/
  const STORE_KEY = "jump100_ch1_v2";
  const defaultSave = () => ({ index: 0, unlocked: [], best: 0 });

  const loadSave = () => {
    try{
      const raw = localStorage.getItem(STORE_KEY);
      if (!raw) return defaultSave();
      const s = JSON.parse(raw);
      if (!s || typeof s.index !== "number") return defaultSave();

      const unlocked = Array.isArray(s.unlocked) ? s.unlocked : [];
      const unlockedClean = [...new Set(unlocked)]
        .map(n => n|0)
        .filter(n => n >= 1 && n <= 100);

      return {
        index: Math.max(0, Math.min(100, s.index|0)),
        unlocked: unlockedClean,
        best: typeof s.best === "number" ? Math.max(0, Math.min(100, s.best|0)) : 0
      };
    }catch(e){ return defaultSave(); }
  };
  let state = loadSave();
  const saveState = () => localStorage.setItem(STORE_KEY, JSON.stringify(state));

  /***********************
   *  3) Canvas / ç‰©ç†å‚æ•°
   ***********************/
  const canvas = document.getElementById("c");
  const ctx = canvas.getContext("2d");
  const DPR = Math.max(1, Math.min(2, window.devicePixelRatio || 1));

  function resize(){
    const rect = canvas.getBoundingClientRect();
    canvas.width = Math.floor(rect.width * DPR);
    canvas.height = Math.floor(rect.height * DPR);
    ctx.setTransform(DPR,0,0,DPR,0,0);
  }
  window.addEventListener("resize", resize);
  resize();

  const world = {
    gravity: 2200,
    groundY: () => canvas.getBoundingClientRect().height * 0.70,
    camX: 0
  };

  const platform = { w: 120, h: 18, gapMin: 110, gapMax: 220, yJitter: 70 };

  const player = {
    x: 0, y: 0, r: 16,
    vx: 0, vy: 0,
    onGround: true,
    charging: false,
    charge: 0,
    chargeStart: 0
  };

  let platforms = [];
  function rand(a,b){ return a + Math.random()*(b-a); }
  function clamp(v,a,b){ return Math.max(a, Math.min(b, v)); }

  function makeNextPlatform(prev){
    const baseY = world.groundY();
    const gap = rand(platform.gapMin, platform.gapMax);
    const y = clamp(prev.y + rand(-platform.yJitter, platform.yJitter), baseY-120, baseY+80);
    const w = rand(90, 150);
    return { x: prev.x + prev.w + gap, y, w, h: platform.h };
  }

  /***********************
   *  4) UI
   ***********************/
  const toast = document.getElementById("toast");
  const toastWho = document.getElementById("toastWho");
  const toastMsg = document.getElementById("toastMsg");
  const toastExpand = document.getElementById("toastExpand");

  const drawer = document.getElementById("drawer");
  const drawerTitle = document.getElementById("drawerTitle");
  const drawerContext = document.getElementById("drawerContext");
  const drawerClose = document.getElementById("drawerClose");

  const modalMask = document.getElementById("modalMask");
  const modalList = document.getElementById("modalList");
  const btnBook = document.getElementById("btnBook");
  const btnReset = document.getElementById("btnReset");
  const btnCloseModal = document.getElementById("btnCloseModal");

  const progressText = document.getElementById("progressText");
  const unlockedText = document.getElementById("unlockedText");

  // è“„åŠ›æ¡
  const chargeWrap = document.getElementById("chargeWrap");
  const chargeFill = document.getElementById("chargeFill");
  const chargePct  = document.getElementById("chargePct");

  // å¤±è´¥
  const failMask = document.getElementById("failMask");
  const btnFailYes = document.getElementById("btnFailYes");
  const btnFailNo  = document.getElementById("btnFailNo");

  // éŸ³ä¹
  const bgm = document.getElementById("bgm");
  const btnMusic = document.getElementById("btnMusic");
  let musicEnabled = false;

  // ç»“å°¾å­—å¹•
  const creditsMask = document.getElementById("creditsMask");
  const creditsInner = document.getElementById("creditsInner");
  const creditsText = document.getElementById("creditsText");
  const btnCreditsClose = document.getElementById("btnCreditsClose");
  const btnCreditsReplay = document.getElementById("btnCreditsReplay");

  // ä½ æƒ³è¯´çš„è¯ï¼ˆåŸæ–‡ä¿ç•™ï¼‰
  const CREDITS_COPY =
`è¿™é¦–æ­Œæ˜¯ä½ åˆ†äº«ç»™æˆ‘çš„ç¬¬ä¸€é¦–æ­Œï¼Œå› ä¸ºè¿™é¦–æ­Œï¼Œæˆ‘ä»¬å¼€å¯äº†ä¸€æ®µç¼˜åˆ†ã€‚
äººä»¬å¸¸è¯´ï¼Œäº‹åœ¨äººä¸ºï¼Œä¸æ˜¯æ— ç¼˜ï¼Œè€Œæ˜¯ä¸æ„¿ã€‚

ä»Šå¤©æ˜¯æˆ‘ä»¬è®¤è¯†çš„ç¬¬ä¸€ä¸ªæƒ…äººèŠ‚ï¼Œä½ è¯´ï¼Œå®å®ï¼Œç‰©è´¨ä¸èƒ½è¡¨è¾¾æ‰€æœ‰çš„ä¸œè¥¿ï¼Œ
æ‰€ä»¥æˆ‘åšäº†è¿™ä¸ªå°æ¸¸æˆã€‚

å®ƒè™½ç„¶å¾ˆç®€å•ï¼Œå´æ˜¯æˆ‘ä»¬åˆç›¸è¯†çš„ç¬¬ä¸€ä¸ª chapterï¼Œ
é‡Œé¢æœ‰è®¸å¤šä½ ä¸æˆ‘æ›¾è¯´è¿‡çš„è¯ã€‚

å¸Œæœ›æ¯æ¬¡ä½ æ‰“å¼€å®ƒçš„æ—¶å€™ï¼Œå°±å¯ä»¥æƒ³åˆ°æˆ‘ï¼Œ
è¿™æ ·æˆ‘å°±ç›¸å½“äºæ°¸è¿œé™ªä¼´åœ¨ä½ èº«è¾¹äº†ã€‚`;

  creditsText.textContent = CREDITS_COPY;

  let toastHideTimer = null;
  let lastShownIdx = 0;

  function updateHUD(){
    progressText.textContent = `${state.index}/100`;
    unlockedText.textContent = `${state.unlocked.length}`;
  }

  function showToast(idx){
    if (idx < 1 || idx > 100) return;
    const line = LINES[idx-1];
    if (!line) return;
    lastShownIdx = idx;
    toastWho.textContent = line.who;
    toastMsg.textContent = line.text;
    toast.style.display = "flex";
  }
  function hideToast(){
    toast.style.display = "none";
    if (toastHideTimer) { clearTimeout(toastHideTimer); toastHideTimer = null; }
  }
  function scheduleToastHide(){
    if (toastHideTimer) clearTimeout(toastHideTimer);
    toastHideTimer = setTimeout(() => hideToast(), 2200);
  }

  function showDrawer(idx){
    const line = LINES[idx-1];
    if (!line) return;
    drawerTitle.textContent = `ç¬¬ ${idx} å¥ Â· ${line.who}`;
    drawerContext.textContent = line.text;
    drawer.style.display = "block";
  }
  function hideDrawer(){ drawer.style.display = "none"; }

  toastExpand.addEventListener("click", () => { if (lastShownIdx) showDrawer(lastShownIdx); });
  drawerClose.addEventListener("click", hideDrawer);

  function escapeHtml(s){
    return String(s).replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;")
      .replaceAll('"',"&quot;").replaceAll("'","&#39;");
  }

  function renderBookList(){
    modalList.innerHTML = "";
    const unlockedSorted = [...new Set(state.unlocked)].sort((a,b)=>a-b);
    if (unlockedSorted.length === 0) {
      const div = document.createElement("div");
      div.style.color = "rgba(0,0,0,.55)";
      div.style.fontSize = "13px";
      div.style.padding = "8px 2px";
      div.textContent = "è¿˜æ²¡è§£é”ä»»ä½•å›å¿†ï¼Œå»è·³ä¸€è·³ ğŸ™‚";
      modalList.appendChild(div);
      return;
    }
    for (const idx of unlockedSorted) {
      const line = LINES[idx-1];
      if (!line) continue;
      const row = document.createElement("div");
      row.className = "line";
      row.innerHTML = `
        <div class="idx">#${idx}</div>
        <div class="who">${escapeHtml(line.who)}</div>
        <div class="txt">${escapeHtml(line.text)}</div>
      `;
      row.addEventListener("click", () => showDrawer(idx));
      modalList.appendChild(row);
    }
  }

  btnBook.addEventListener("click", () => { modalMask.style.display = "flex"; renderBookList(); });
  btnCloseModal.addEventListener("click", () => { modalMask.style.display = "none"; });
  modalMask.addEventListener("click", (e) => { if (e.target === modalMask) modalMask.style.display = "none"; });

  /***********************
   *  5) éŸ³ä¹æ§åˆ¶ï¼ˆç§»åŠ¨ç«¯ï¼šå¿…é¡»ç”¨æˆ·æ‰‹åŠ¿è§¦å‘ï¼‰
   ***********************/
  function setMusicBtn(){
    btnMusic.textContent = musicEnabled ? "ğŸ”Š éŸ³ä¹ï¼šå¼€" : "ğŸ”ˆ éŸ³ä¹ï¼šå…³";
  }
  setMusicBtn();

  async function tryPlayMusic(){
    if (!musicEnabled) return;
    try{
      await bgm.play();
    }catch(e){
      // ç§»åŠ¨ç«¯å¯èƒ½ä¼šé˜»æ­¢éæ‰‹åŠ¿æ’­æ”¾ï¼šä¸æŠ¥é”™ç»™ç”¨æˆ·
    }
  }

  btnMusic.addEventListener("click", async () => {
    musicEnabled = !musicEnabled;
    setMusicBtn();
    if (musicEnabled) await tryPlayMusic();
    else { try{ bgm.pause(); }catch(e){} }
  });

  /***********************
   *  6) å…³å¡åˆå§‹åŒ–
   ***********************/
  function initLevel(){
    const baseY = world.groundY();
    world.camX = 0;
    platforms = [];
    platforms.push({ x: 80, y: baseY, w: platform.w, h: platform.h });
    platforms.push(makeNextPlatform(platforms[0]));
    platforms.push(makeNextPlatform(platforms[1]));

    const p0 = platforms[0];
    player.x = p0.x + p0.w/2;
    player.y = p0.y - player.r;
    player.vx = 0; player.vy = 0;
    player.onGround = true;
    player.charging = false;
    player.charge = 0;

    hideToast();
    hideDrawer();
    updateHUD();
  }

  /***********************
   *  7) äº¤äº’ï¼šæŒ‰ä½è“„åŠ› / æ¾å¼€è·³ï¼ˆå¤±è´¥é”å®š + ç»“å°¾é”å®šï¼‰
   ***********************/
  let endMode = false;
  let failMode = false;

  // æŒ‰ä½æ—¶é—´å†³å®šåŠ›åº¦ï¼ˆä½ ä¹‹å‰è®¤å¯çš„æ‰‹æ„Ÿï¼‰
  const MIN_HOLD = 80;
  const MAX_HOLD = 1500;

  function setChargeUI(c){
    const pct = Math.round(c * 100);
    chargeFill.style.width = `${pct}%`;
    chargePct.textContent = `${pct}%`;
  }

  function pointerDown(){
    // âœ… ç¬¬ä¸€æ¬¡è§¦å‘æ“ä½œæ—¶ï¼Œå°è¯•æ’­æ”¾éŸ³ä¹ï¼ˆç¬¦åˆæ‰‹æœºç­–ç•¥ï¼šç”¨æˆ·æ‰‹åŠ¿è§¦å‘ï¼‰
    if (musicEnabled) tryPlayMusic();

    if (endMode || failMode) return;
    if (!player.onGround) return;
    player.charging = true;
    player.chargeStart = performance.now();
    player.charge = 0;
    chargeWrap.style.display = "flex";
    setChargeUI(0);
  }

  function pointerUp(){
    if (endMode || failMode) return;
    if (!player.charging) return;
    player.charging = false;
    chargeWrap.style.display = "none";

    const c = clamp(player.charge, 0, 1);

    // è½»ç‚¹å°è·³
    if (c === 0) {
      player.vx = 140;
      player.vy = -520;
      player.onGround = false;
      scheduleToastHide();
      return;
    }

    const baseSpeed = 180;
    const extraSpeed = 520;
    const jumpVy = -620;

    player.vx = baseSpeed + extraSpeed * c;
    player.vy = jumpVy - 120 * c;
    player.onGround = false;
    scheduleToastHide();
  }

  canvas.addEventListener("pointerdown", pointerDown);
  window.addEventListener("pointerup", pointerUp);

  /***********************
   *  8) å¤±è´¥é€»è¾‘
   ***********************/
  function respawnOnLastPlatform(){
    const cand = platforms
      .filter(p => p.x + p.w/2 <= player.x)
      .sort((a,b)=> (a.x+a.w)-(b.x+b.w));
    const p = cand.length ? cand[cand.length-1] : platforms[0];

    player.x = p.x + p.w/2;
    player.y = p.y - player.r;
    player.vx = 0; player.vy = 0;
    player.onGround = true;
    player.charging = false;
    player.charge = 0;

    chargeWrap.style.display = "none";
    hideToast();
    hideDrawer();
  }

  function triggerFail(){
    if (endMode || failMode) return;
    failMode = true;

    player.charging = false;
    player.vx = 0; player.vy = 0;
    chargeWrap.style.display = "none";
    hideToast();
    hideDrawer();

    failMask.style.display = "flex";
  }

  btnFailYes.addEventListener("click", () => {
    state = defaultSave();
    saveState();
    failMode = false;
    failMask.style.display = "none";
    endMode = false;
    creditsMask.style.display = "none";
    initLevel();
  });

  btnFailNo.addEventListener("click", () => {
    failMode = false;
    failMask.style.display = "none";
    respawnOnLastPlatform();
  });

  /***********************
   *  9) ç»“å°¾æ»šåŠ¨å­—å¹•
   ***********************/
  function showCredits(){
    creditsMask.style.display = "block";
    // é‡ç½®åŠ¨ç”»ï¼šå¼ºåˆ¶ reflow
    creditsInner.style.animation = "none";
    void creditsInner.offsetHeight;
    creditsInner.style.animation = "creditsScroll 26s linear forwards";
  }

  btnCreditsClose.addEventListener("click", () => {
    creditsMask.style.display = "none";
  });

  btnCreditsReplay.addEventListener("click", () => {
    creditsMask.style.display = "none";
    state = defaultSave();
    saveState();
    failMode = false;
    endMode = false;
    initLevel();
  });

  /***********************
   *  10) è§£é”
   ***********************/
  function unlockNext(){
    if (state.index >= 100) return;

    state.index += 1;
    const idx = state.index;

    if (!state.unlocked.includes(idx)) state.unlocked.push(idx);
    state.best = Math.max(state.best, state.index);
    saveState();
    updateHUD();

    showToast(idx);
    scheduleToastHide();

    const last = platforms[platforms.length - 1];
    platforms.push(makeNextPlatform(last));

    if (idx === 100) {
      endMode = true;
      failMode = false;
      player.charging = false;
      player.vx = 0; player.vy = 0;
      chargeWrap.style.display = "none";

      // âœ… ç»ˆç« ï¼šå¼¹æ»šåŠ¨å­—å¹•
      showCredits();
    }
  }

  /***********************
   *  11) ç‰©ç†æ›´æ–° + ç¢°æ’
   ***********************/
  function step(dt){
    if (!endMode && !failMode && player.charging) {
      const holdMs = performance.now() - player.chargeStart;
      const t = (holdMs - MIN_HOLD) / (MAX_HOLD - MIN_HOLD);
      player.charge = clamp(t, 0, 1);
      setChargeUI(player.charge);
    }

    if (!endMode && !failMode) {
      if (!player.onGround) {
        player.vy += world.gravity * dt;
        player.x += player.vx * dt;
        player.y += player.vy * dt;
      } else {
        player.vx *= 0.98;
      }

      const viewW = canvas.getBoundingClientRect().width;
      const targetCam = player.x - viewW * 0.35;
      world.camX = Math.max(0, targetCam);

      if (!player.onGround) {
        for (const p of platforms) {
          const px1 = p.x, px2 = p.x + p.w;
          const py = p.y;
          const withinX = (player.x > px1 - player.r) && (player.x < px2 + player.r);
          const falling = player.vy > 0;
          const footY = player.y + player.r;

          if (withinX && falling && footY >= py - 6 && footY <= py + 22) {
            player.y = py - player.r;
            player.vy = 0;
            player.onGround = true;
            unlockNext();
            break;
          }
        }

        const H = canvas.getBoundingClientRect().height;
        if (player.y > H + 240) triggerFail();
      }
    }
  }

  /***********************
   *  12) ç»˜åˆ¶
   ***********************/
  function roundRect(ctx, x,y,w,h,r){
    const rr = Math.min(r, w/2, h/2);
    ctx.beginPath();
    ctx.moveTo(x+rr,y);
    ctx.arcTo(x+w,y, x+w,y+h, rr);
    ctx.arcTo(x+w,y+h, x,y+h, rr);
    ctx.arcTo(x,y+h, x,y, rr);
    ctx.arcTo(x,y, x+w,y, rr);
    ctx.closePath();
  }

  function draw(){
    const W = canvas.getBoundingClientRect().width;
    const H = canvas.getBoundingClientRect().height;
    ctx.clearRect(0,0,W,H);
    // âœ… å…ˆç”»èƒŒæ™¯å›¾ï¼ˆcover é“ºæ»¡ï¼‰
    if (bgReady) {
      const iw = bgImg.naturalWidth || bgImg.width;
      const ih = bgImg.naturalHeight || bgImg.height;

      // cover ç¼©æ”¾ï¼šä¿è¯é“ºæ»¡å±å¹•
      const scale = Math.max(W / iw, H / ih);
      const dw = iw * scale;
      const dh = ih * scale;
      const dx = (W - dw) / 2;
      const dy = (H - dh) / 2;

      ctx.drawImage(bgImg, dx, dy, dw, dh);

      // âœ… è½»ç°è’™ç‰ˆï¼šé™ä½åˆºçœ¼æ„Ÿï¼ˆå¯è°ƒï¼‰
      ctx.fillStyle = "rgba(246,247,251,0.70)"; // è¶Šå¤§è¶Šâ€œç°â€
      ctx.fillRect(0, 0, W, H);
    } else {
      // å›¾ç‰‡æœªåŠ è½½æ—¶çš„å…œåº•ï¼ˆä¿æŒåŸæ¥é‚£å¥—æµ…ç°ï¼‰
      ctx.fillStyle = "rgba(246,247,251,1)";
      ctx.fillRect(0, 0, W, H);
    }


    // èƒŒæ™¯æ¸å˜ï¼ˆæµ…ç°æ›´æŸ”å’Œï¼‰
    const g = ctx.createLinearGradient(0,0,0,H);
    g.addColorStop(0,"rgba(0,0,0,0.02)");
    g.addColorStop(1,"rgba(0,0,0,0)");
    ctx.fillStyle = g;
    ctx.fillRect(0,0,W,H);

    for (const p of platforms) {
      const sx = p.x - world.camX;
      const sy = p.y;
      if (sx < -260 || sx > W + 260) continue;

      ctx.fillStyle = "rgba(0,0,0,0.10)";
      roundRect(ctx, sx, sy+3, p.w, p.h, 10);
      ctx.fill();

      ctx.fillStyle = "rgba(255,255,255,0.95)";
      roundRect(ctx, sx, sy, p.w, p.h, 10);
      ctx.fill();
    }

    const px = player.x - world.camX;
    const py = player.y;

    if (!endMode && !failMode && player.charging) {
      const t = clamp(player.charge, 0, 1);
      ctx.beginPath();
      ctx.arc(px, py, player.r + 12 + 10*t, 0, Math.PI*2);
      ctx.strokeStyle = "rgba(0,0,0,0.10)";
      ctx.lineWidth = 4;
      ctx.stroke();
    }

    ctx.beginPath();
    ctx.arc(px, py, player.r, 0, Math.PI*2);
    ctx.fillStyle = "rgba(0,0,0,0.78)";
    ctx.fill();
  }

  /***********************
   *  13) ä¸»å¾ªç¯
   ***********************/
  let lastT = performance.now();
  function loop(t){
    const dt = Math.min(0.033, (t - lastT)/1000);
    lastT = t;
    step(dt);
    draw();
    requestAnimationFrame(loop);
  }

  /***********************
   *  14) é‡ç½®æŒ‰é’®
   ***********************/
  btnReset.addEventListener("click", () => {
    state = defaultSave();
    saveState();
    failMode = false;
    failMask.style.display = "none";
    endMode = false;
    creditsMask.style.display = "none";
    initLevel();
  });

  /***********************
    /***********************
   *  15) åˆå§‹åŒ–
   ***********************/
  initLevel();
  updateHUD();

  // å¦‚æœå·²åˆ° 100ï¼Œç›´æ¥æ˜¾ç¤ºå­—å¹•
  if (state.index >= 100) {
    endMode = true;
    showCredits();

    

  } else if (state.index > 0) {
    showToast(state.index);
    scheduleToastHide();
  }

  // âœ… ä½ æ¼æ‰çš„ï¼šå¯åŠ¨ä¸»å¾ªç¯ï¼ˆå¿…é¡»è¦æœ‰ï¼‰
  requestAnimationFrame(loop);
})();

</script>
</body>
</html>





