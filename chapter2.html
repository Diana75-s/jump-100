<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>Chapter 2 ¬∑ ÂâßÊÉÖÈÄâÊã©</title>
  <style>
    :root{
      --bg1:#0b0f1a;
      --bg2:#0f172a;
      --card:rgba(255,255,255,.08);
      --card2:rgba(255,255,255,.12);
      --ink:rgba(255,255,255,.92);
      --muted:rgba(255,255,255,.65);
      --muted2:rgba(255,255,255,.45);
      --accent:#7dd3fc;
      --danger:#ff4d4f;
      --ok:#34d399;
      --shadow:0 18px 60px rgba(0,0,0,.45);
      --radius:22px;
    }
    *{box-sizing:border-box}
    html,body{height:100%;margin:0}
    body{
      background: radial-gradient(1200px 800px at 30% 10%, #1f2a44 0%, transparent 60%),
                  radial-gradient(1000px 700px at 80% 40%, #0b2b3a 0%, transparent 55%),
                  linear-gradient(180deg, var(--bg2), var(--bg1));
      color:var(--ink);
      font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Helvetica,Arial,"PingFang SC","Noto Sans SC","Microsoft YaHei",sans-serif;
      overflow:hidden;
    }

    .wrap{height:100%;display:flex;align-items:center;justify-content:center;padding:18px}
    .phone{
      width:min(420px, 100%);
      height:min(860px, 100%);
      background:rgba(0,0,0,.25);
      border:1px solid rgba(255,255,255,.10);
      border-radius:34px;
      box-shadow: var(--shadow);
      position:relative;
      overflow:hidden;
      backdrop-filter: blur(10px);
    }
    .safe{
      padding: max(16px, env(safe-area-inset-top)) 16px max(16px, env(safe-area-inset-bottom)) 16px;
      height:100%;
      display:flex;
      flex-direction:column;
      gap:12px;
      min-height:0;
    }

    .topbar{
      display:flex; align-items:center; justify-content:space-between;
      font-size:12px; color:var(--muted2);
      letter-spacing:.2px;
      flex:0 0 auto;
      gap:10px;
    }
    .pill{
      background:rgba(255,255,255,.08);
      border:1px solid rgba(255,255,255,.10);
      padding:8px 10px;
      border-radius:999px;
      display:inline-flex; gap:8px; align-items:center;
      white-space:nowrap;
    }
    .dot{width:6px;height:6px;border-radius:50%;background:var(--accent); box-shadow:0 0 18px rgba(125,211,252,.6)}

    /* ‚úÖ Âè≥‰∏äËßíÂ∞èÊåâÈíÆÔºàÈü≥‰πêÂºÄÂÖ≥Ôºâ */
    .pillBtn{
      border:1px solid rgba(255,255,255,.10);
      background:rgba(255,255,255,.06);
      color:rgba(255,255,255,.80);
      border-radius:999px;
      padding:8px 10px;
      cursor:pointer;
      -webkit-tap-highlight-color: transparent;
      transition: transform 120ms ease, background 200ms ease, opacity 200ms ease;
      display:inline-flex; align-items:center; gap:8px;
      font-size:12px;
    }
    .pillBtn:hover{background:rgba(255,255,255,.10)}
    .pillBtn:active{transform: translateY(1px)}
    .pillBtn .ic{opacity:.9}

    .stage{
      flex:1 1 auto;
      min-height:0;
      display:flex;
      flex-direction:column;
      gap:12px;
      position:relative;
    }

    .header{
      display:flex; align-items:flex-end; justify-content:space-between; gap:10px;
      flex:0 0 auto;
    }
    .title{font-size:18px; font-weight:700; letter-spacing:.2px}
    .subtitle{font-size:12px;color:var(--muted2)}
    .progress{
      height:8px; width:120px; border-radius:999px;
      background:rgba(255,255,255,.10);
      overflow:hidden;
    }
    .bar{
      height:100%; width:0%;
      background:linear-gradient(90deg, rgba(125,211,252,.9), rgba(52,211,153,.85));
      border-radius:999px;
      transition: width 600ms ease;
    }

    .card{
      background:var(--card);
      border:1px solid rgba(255,255,255,.10);
      border-radius: var(--radius);
      padding:14px 14px;
      box-shadow: 0 10px 30px rgba(0,0,0,.25);
    }

    .card.dialogue{
      flex:1 1 auto;
      min-height:0;
      overflow:auto;
      -webkit-overflow-scrolling: touch;
    }
    .lines{
      display:flex; flex-direction:column; gap:8px;
      min-height:0;
      padding-bottom:6px;
    }

    .line{
      opacity:0;
      transform: translateY(10px);
      transition: opacity 420ms ease, transform 420ms ease;
      color:var(--ink);
      line-height:1.55;
      font-size:15px;
      white-space:pre-wrap;
    }
    .line.show{opacity:1; transform: translateY(0)}
    .line.muted{color:var(--muted)}
    .line.sys{color:var(--muted2); font-size:13px}
    .line.em{color:var(--accent); font-weight:650}

    .choices{display:grid; gap:10px}
    .btn{
      width:100%;
      border-radius:16px;
      padding:12px 12px;
      border:1px solid rgba(255,255,255,.14);
      background:rgba(255,255,255,.08);
      color:var(--ink);
      font-size:15px;
      text-align:left;
      cursor:pointer;
      transition: transform 120ms ease, background 240ms ease, border-color 240ms ease, opacity 240ms ease;
      user-select:none;
      -webkit-tap-highlight-color: transparent;
      position:relative;
      overflow:hidden;
    }
    .btn:hover{background:rgba(255,255,255,.12)}
    .btn:active{transform: translateY(1px) scale(.99)}
    .btn .tag{
      display:inline-flex; align-items:center; justify-content:center;
      width:26px; height:26px; border-radius:10px;
      margin-right:10px;
      font-weight:800;
      background:rgba(125,211,252,.12);
      border:1px solid rgba(125,211,252,.20);
      color:rgba(125,211,252,.95);
      font-size:13px;
    }
    .btn.disabled{opacity:.45; pointer-events:none}
    .btn.fade{opacity:.22; filter: blur(.2px)}
    .btn::after{
      content:"";
      position:absolute; inset:-40%;
      background: radial-gradient(circle at 20% 20%, rgba(255,255,255,.16), transparent 55%);
      transform: rotate(12deg);
      opacity:0;
      transition: opacity 240ms ease;
    }
    .btn:hover::after{opacity:1}

    .overlay{
      position:absolute; inset:0;
      display:flex; align-items:center; justify-content:center;
      background:rgba(0,0,0,.55);
      backdrop-filter: blur(8px);
      opacity:0; pointer-events:none;
      transition: opacity 360ms ease;
      padding:18px;
    }
    .overlay.show{opacity:1; pointer-events:auto}
    .panel{
      width:100%;
      max-width: 380px;
      background:rgba(10,14,24,.78);
      border:1px solid rgba(255,255,255,.12);
      border-radius: 26px;
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .panelHead{
      padding:14px 14px;
      border-bottom:1px solid rgba(255,255,255,.10);
      display:flex; align-items:center; justify-content:space-between;
      gap:10px;
    }
    .panelHead .h{font-weight:750}
    .panelBody{padding:14px 14px}
    .small{font-size:12px;color:var(--muted2)}

    .chat{
      background:rgba(255,255,255,.06);
      border:1px solid rgba(255,255,255,.10);
      border-radius: 20px;
      padding:12px;
      display:flex; flex-direction:column; gap:10px;
    }
    .msg{
      max-width: 82%;
      padding:10px 12px;
      border-radius: 16px;
      font-size:14px;
      line-height:1.4;
      border:1px solid rgba(255,255,255,.10);
      background:rgba(255,255,255,.08);
    }
    .msg.me{align-self:flex-end; background:rgba(125,211,252,.10); border-color:rgba(125,211,252,.18)}
    .msg.them{align-self:flex-start}
    .chatTop{
      display:flex; align-items:center; justify-content:space-between;
      color:var(--muted2);
      font-size:12px;
      margin-bottom:2px;
    }
    .excl{
      display:inline-flex; align-items:center; gap:8px;
      color: rgba(255,255,255,.85);
    }
    .badgeDanger{
      width:16px;height:16px;border-radius:50%;
      background:var(--danger);
      display:inline-flex; align-items:center; justify-content:center;
      color:#fff; font-weight:900; font-size:12px;
      box-shadow:0 0 18px rgba(255,77,79,.45);
    }

    .call{
      display:flex; flex-direction:column; align-items:center; justify-content:center;
      gap:12px; padding:18px;
    }
    .avatar{
      width:84px;height:84px;border-radius:28px;
      background:rgba(125,211,252,.10);
      border:1px solid rgba(125,211,252,.20);
      display:flex; align-items:center; justify-content:center;
      font-weight:900;
      color:rgba(125,211,252,.95);
      font-size:24px;
      box-shadow:0 0 30px rgba(125,211,252,.15);
      transform: translateZ(0);
      animation: floaty 2.6s ease-in-out infinite;
    }
    @keyframes floaty{ 0%,100%{transform:translateY(0)} 50%{transform:translateY(-6px)} }
    .ring{
      width:10px;height:10px;border-radius:50%;
      background:var(--ok);
      box-shadow:0 0 18px rgba(52,211,153,.55);
    }
    .shake{ animation: shake 420ms ease; }
    @keyframes shake{
      0%,100%{transform:translateX(0)}
      20%{transform:translateX(-6px)}
      40%{transform:translateX(6px)}
      60%{transform:translateX(-4px)}
      80%{transform:translateX(4px)}
    }

    .footer{
      display:flex; justify-content:space-between; align-items:center; gap:10px;
      flex:0 0 auto;
    }
    .linkbtn{
      background:transparent;
      border:1px solid rgba(255,255,255,.14);
      color:var(--muted);
      border-radius:14px;
      padding:10px 12px;
      cursor:pointer;
      transition: background 200ms ease, transform 120ms ease;
    }
    .linkbtn:hover{background:rgba(255,255,255,.06)}
    .linkbtn:active{transform: translateY(1px)}
    .primary{
      border-color: rgba(125,211,252,.28);
      color: rgba(125,211,252,.95);
    }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="phone">

      <!-- ‚úÖ BGM2ÔºöÊää bgm2.mp3 ÊîæÂà∞ chapter2.html ÂêåÁõÆÂΩï -->
      <audio id="bgm2" src="bgm2.mp3" preload="auto" loop></audio>

      <div class="safe">
        <div class="topbar">
          <div class="pill"><span class="dot"></span><span id="modeText">Chapter 2 ¬∑ ÂâßÊÉÖÈÄâÊã©</span></div>

          <!-- ‚úÖ Âè≥‰æßÔºöÈü≥‰πêÊåâÈíÆ + Êó∂Èíü -->
          <div style="display:flex; gap:10px; align-items:center;">
            <button class="pillBtn" id="btnMusic2" type="button">
              <span class="ic">üîà</span><span id="musicText2">Èü≥‰πêÔºöÂÖ≥</span>
            </button>
            <div class="pill"><span id="clock">--:--</span></div>
          </div>
        </div>

        <div class="stage">
          <div class="header">
            <div>
              <div class="title" id="sceneTitle">Scene 1 ¬∑ ÈÇ£ÈÄöÁîµËØù‰πãÂêé</div>
              <div class="subtitle" id="sceneSub">ÂêÉÂêÉËßÜËßí ¬∑ ‰Ω†ËøòÊúâ‰∏ÄÂè•ËØùÊ≤°ËØ¥ÂÆå</div>
            </div>
            <div class="progress" aria-label="progress">
              <div class="bar" id="bar"></div>
            </div>
          </div>

          <div class="card dialogue">
            <div class="lines" id="lines"></div>
          </div>

          <div class="card">
            <div class="choices" id="choices"></div>
          </div>
        </div>

        <div class="footer">
          <button class="linkbtn" id="restartBtn">ÈáçÊù•</button>
          <button class="linkbtn primary" id="skipBtn">Âø´ÈÄüË∑≥ËøáÊñáÂ≠ó</button>
        </div>
      </div>

      <div class="overlay" id="overlay">
        <div class="panel">
          <div class="panelHead">
            <div class="h" id="endTitle">ÁªìÂ±Ä</div>
            <button class="linkbtn" id="continueBtn">ÁªßÁª≠</button>
          </div>
          <div class="panelBody" id="endBody"></div>
          <div class="panelBody small" id="endNote"></div>
        </div>
      </div>
    </div>
  </div>

<script>
(() => {
  const $ = (id) => document.getElementById(id);

  // --- BGM2Ôºà‚úÖÂíå Chapter1 ‰∏ÄÊ†∑ÔºöÂøÖÈ°ªÊâãÂäøËß¶ÂèëÊí≠ÊîæÔºâ ---
  const bgm2 = $('bgm2');
  const btnMusic2 = $('btnMusic2');
  const musicText2 = $('musicText2');
  let musicEnabled2 = false;

  function setMusicBtn2(){
    musicText2.textContent = musicEnabled2 ? "Èü≥‰πêÔºöÂºÄ" : "Èü≥‰πêÔºöÂÖ≥";
    btnMusic2.querySelector('.ic').textContent = musicEnabled2 ? "üîä" : "üîà";
  }
  setMusicBtn2();

  async function tryPlayMusic2(){
    if (!musicEnabled2) return;
    try{ await bgm2.play(); }catch(e){}
  }

  btnMusic2.addEventListener('click', async () => {
    musicEnabled2 = !musicEnabled2;
    setMusicBtn2();
    if (musicEnabled2) await tryPlayMusic2();
    else { try{ bgm2.pause(); }catch(e){} }
  });

  // ‚úÖ‰ªªÊÑèÁî®Êà∑ÊâãÂäøÊó∂ÔºåÂ¶ÇÊûúÂ∑≤ÂºÄÂêØÈü≥‰πêÔºåÂ∞±Â∞ùËØïÊí≠ÊîæÔºàËß£ÂÜ≥ iOS ÈôêÂà∂Ôºâ
  function onAnyUserGesture(){
    if (musicEnabled2) tryPlayMusic2();
  }
  window.addEventListener('pointerdown', onAnyUserGesture, {passive:true});
  window.addEventListener('touchstart', onAnyUserGesture, {passive:true});

  // --- clock ---
  function tickClock(){
    const d = new Date();
    const hh = String(d.getHours()).padStart(2,'0');
    const mm = String(d.getMinutes()).padStart(2,'0');
    $('clock').textContent = `${hh}:${mm}`;
  }
  tickClock(); setInterval(tickClock, 10000);

  // --- data ---
  const game = { nodeId: "S1_START", fast: false };
  let isTyping = false;
  let cancelToken = { cancelled:false };

  const nodes = {
    S1_START: {
      scene: 1,
      title: "Scene 1 ¬∑ ÈÇ£ÈÄöÁîµËØù‰πãÂêé",
      sub: "ÂêÉÂêÉËßÜËßí ¬∑ ‰Ω†ËøòÊúâ‰∏ÄÂè•ËØùÊ≤°ËØ¥ÂÆå",
      lines: [
        "ÁîµËØùÊåÇÊñ≠‰∫Ü",
        "‰Ω†ÂàöÂàö\nÊääËá™Â∑±‰ªéÂ∞èÂà∞Â§ßÁöÑÁªèÂéÜ\n‰∏ÄËÇ°ËÑëÂú∞ËØ¥ÂÆå",
        "‰Ω†ËØ¥\n‰∏çÁÆ°‰ª•‰ªÄ‰πàÂÖ≥Á≥ª\nÈÉΩÂ∏åÊúõ‰ª•ÂêéËøòËÉΩÁªßÁª≠Áõ∏Â§Ñ",
        {pause: 1000},
        "ÊâãÊú∫Âèà‰∫Æ‰∫Ü‰∏Ä‰∏ã",
        {em: "Â•πÂèëÊù•‰∏ÄÂè•\nÊôöÂÆâ"},
        {pause: 800},
        "‰Ω†ÁõØÁùÄÈÇ£‰∏§‰∏™Â≠ó\nÁúã‰∫Ü‰∏Ä‰ºöÂÑø",
        "‰Ω†Á™ÅÁÑ∂ÊÉ≥Ëµ∑\nËøáÂéªÁöÑ‰∏ÄÊÆµÁªèÂéÜ",
        "ÈÇ£‰∏ÄÊ¨°\n‰Ω†‰πüÊòØËøôÊ†∑\nËØùËØ¥Âà∞‰∏ÄÂçä\nÂ∞±Ë¢´‰∏ÄÂè•\nÁúãËµ∑Êù•ÂæàÊ≠£Â∏∏ÁöÑËØù\nÁªìÊùü‰∫Ü",
        "‰Ω†ÊÑèËØÜÂà∞\n‰Ω†ËøòÊúâ‰∏ÄÂè•ËØù\nÊ≤°ÊúâËØ¥ÂÆå",
        "ÈÇ£Âè•ËØù\nÂ¶ÇÊûúÁé∞Âú®‰∏çËØ¥\nÂèØËÉΩÂ∞±ÂÜç‰πüÊ≤°ÊúâÊú∫‰ºö‰∫Ü",
      ],
      choices: [
        { key:"A", text:"Ê¥óÊº±Â•ΩÔºå‰ºëÊÅØ", next:"S1_END_A1" },
        { key:"B", text:"ÂÜçÊâì‰∏Ä‰∏™ÁîµËØùÁªôËé´ÊñØÁßëÁöÑÂ∞èÁüÆ‰∫∫", next:"S1_END_B1" },
      ],
      progress: 33,
    },

    S1_END_A1: {
      scene: 1,
      ending: true,
      endTitle: "ÁªìÂ±Ä A1 ¬∑ Ê∂àÊÅØÂèëÈÄÅÂ§±Ë¥•",
      endBody: () => renderChatFail(),
      endNote: "‰Ω†Ê≤°ÊúâÂÅöÈîô„ÄÇ\nÂè™ÊòØÊúâ‰∫õÊ≤âÈªò‰ºöÊàê‰∏∫ÊúÄÂêé‰∏ÄÊ¨°„ÄÇ",
      nextAfterEnding: "S2_START",
      progress: 33,
    },

    S1_END_B1: {
      scene: 1,
      ending: true,
      endTitle: "ÁªìÂ±Ä B1 ¬∑ Âº∫Ë°åÁª≠ÂëΩ",
      endBody: () => renderCallScene("Ëé´ÊñØÁßëÁöÑÂ∞èÁüÆ‰∫∫", [
        "Â•πÂá†‰πéÊòØÊÖå‰π±Âú∞Êé•Ëµ∑‰∫ÜÁîµËØù",
        "ÈóÆ‰Ω†ÔºöÊÄé‰πà‰∫Ü",
        "‰Ω†ËØ≠Ê∞îÂèòÂæóÂæàËÆ§Áúü",
        "‰Ω†ËØ¥ÔºöÊó†ËÆ∫Â¶Ç‰Ωï\n‰∏çÂèØ‰ª•Âà†Èô§Êàë",
        "‰Ω†Â∏åÊúõ\nÊòéÂ§©ËøòËÉΩÁªßÁª≠ËÅäÂ§©",
        "Â•πÊ≤âÈªò‰∫Ü‰∏Ä‰∏ã\nÁÑ∂ÂêéÁ≠îÂ∫î‰∫Ü",
        "ÁîµËØùÊåÇÊñ≠\nÂ§úÈáçÊñ∞ÂÆâÈùô‰∏ãÊù•",
      ]),
      endNote: "‰Ω†ÊääËØùËØ¥ÂÆå‰∫Ü„ÄÇ\n‰ΩÜÁªìÂ±Ä‰ªç‰∏ç‰øùËØÅÁî±‰Ω†ÂÜ≥ÂÆö„ÄÇ",
      nextAfterEnding: "S2_START",
      progress: 33,
    },

    S2_START: {
      scene: 2,
      title: "Scene 2 ¬∑ Â•πÂì≠ÁöÑÊó∂ÂÄô",
      sub: "‰ª∑ÂÄºÁ´ô‰Ωç ¬∑ ‰Ω†Áü•ÈÅìËøô‰ºöÊîπÂèòÂ•πÁúã‰Ω†ÁöÑÊñπÂºè",
      lines: [
        "Â•πÂºÄÂßãË∑ü‰Ω†ËØ¥\nÂ•πÂíåÂâç‰ªªÂàÜÊâãÁöÑÂéüÂõ†",
        "‰∏çÊòØÊüê‰∏Ä‰ª∂ÂÖ∑‰ΩìÁöÑ‰∫ã",
        "ËÄåÊòØ\n‰∏ÄÊ¨°Ê¨°ÂÖ≥‰∫éÁî∑Â•≥ÂØπÁ´ãÁöÑ‰∫âÂêµ",
        "Â•πËØ¥\nÂ•πÂè™ÊòØÊÉ≥Ë¢´ÁêÜËß£",
        "‰ΩÜÊØè‰∏ÄÊ¨°ËÆ®ËÆ∫\nÊúÄÂêéÈÉΩ‰ºöÂèòÊàê\nË∞ÅÁ´ôÂú®Âì™‰∏ÄËæπ",
        "ËØ¥ÁùÄËØ¥ÁùÄ\nÂ•πÂì≠‰∫Ü",
        "‰Ω†ÊÑèËØÜÂà∞\nÂ•π‰∏çÊòØÂú®ÈóÆ‰Ω†\nË∞ÅÂØπË∞ÅÈîô",
        "Â•πÂè™ÊòØ\nÊúâÁÇπÊíë‰∏ç‰Ωè‰∫Ü",
        {pause: 900},
        {muted:"‰Ω†Áü•ÈÅì\n‰∏çÁÆ°‰Ω†Êé•‰∏ãÊù•ÊÄé‰πàÂõûÂ∫î\nÈÉΩ‰ºöÊîπÂèò\nÂ•πÁúã‰Ω†ÁöÑÊñπÂºè"},
      ],
      choices: [
        { key:"A", text:"ÂÖàÁ´ôÂú®Â•πËøôËæπ", next:"S2_END_A2" },
        { key:"B", text:"ÂÖàÂê¨Ê∏ÖÊ•öÔºåÂÜçÂàÜÊûê", next:"S2_END_B2" },
        { key:"C", text:"Áõ¥ËØ¥‰Ω†‰∏çÂêåÊÑèÂ•πÁöÑÁúãÊ≥ï", next:"S2_END_C2" },
      ],
      progress: 66,
    },

    S2_END_A2: {
      scene: 2, ending: true,
      endTitle: "ÁªìÂ±Ä A2 ¬∑ Ë¢´ÁêÜËß£Ôºå‰ΩÜ‰∏çË¢´‰ø°‰ªª",
      endBody: () => renderSystemPanel([
        "‰Ω†Ê≤°ÊúâÊâìÊñ≠Â•π",
        "‰Ω†È°∫ÁùÄÂ•πÁöÑËØù\n‰∏ÄÂè•‰∏ÄÂè•ÂÆâÊÖ∞",
        "Â•πÊÑ£‰∫Ü‰∏Ä‰∏ã",
        "ÁÑ∂ÂêéÂ•πÁ™ÅÁÑ∂ÊÑèËØÜÂà∞\n‰Ω†Ê≤°ÊúâÂú®ÊÉ≥",
        "‰Ω†Âè™ÊòØÂú®\nÈô™Â•πËØ¥ËØù",
        {danger:"Â•πÈÄâÊã©ÊãâÈªë‰Ω†"},
      ]),
      endNote: "ÊÉÖÁª™ÂØπÈΩêÊúâÊó∂‰ºöË¢´ËØØËØª‰∏∫Êï∑Ë°ç„ÄÇ",
      nextAfterEnding: "S3_START",
      progress: 66,
    },

    S2_END_B2: {
      scene: 2, ending: true,
      endTitle: "ÁªìÂ±Ä B2 ¬∑ Ë¢´Â∞äÈáçÔºå‰ΩÜË∑ùÁ¶ªÊãâÂºÄ",
      endBody: () => renderSystemPanel([
        "‰Ω†ËÆ©Â•πÊÖ¢ÊÖ¢ËØ¥\nÊ≤°ÊúâÊÄ•ÁùÄÂõûÂ∫î",
        "Á≠âÂ•πËØ¥ÂÆå\n‰Ω†ÊâçÂºÄÂßãÂàÜÊûê",
        "Â•πÂê¨ÂæóÂæàËÆ§Áúü",
        "Ê≤°ÊúâÂèçÈ©≥\n‰πüÊ≤°ÊúâË°®Á§∫ËµûÂêå",
        {muted:"Â•π‰æùÊóßÂÖ≥ÂøÉ\n‰ΩÜ‰∏çÂÜçÈù†Ëøë"},
        {ok:"Â•π‰øùÁïô‰∫Ü‰Ω†ÁöÑËÅîÁ≥ªÊñπÂºè"},
      ]),
      endNote: "Ê≠£Á°Æ‰∏çÁ≠â‰∫éÈù†Ëøë„ÄÇ",
      nextAfterEnding: "S3_START",
      progress: 66,
    },

    S2_END_C2: {
      scene: 2, ending: true,
      endTitle: "ÁªìÂ±Ä C2 ¬∑ ÈùôÈªò‰∏çÂõû",
      endBody: () => renderSystemPanel([
        "‰Ω†ËØ¥Âá∫‰∫Ü‰Ω†ÁöÑÁúüÂÆûÊÉ≥Ê≥ï",
        "Â•πÊ≤°ÊúâÂèçÈ©≥\nÂè™ÊòØÁ¨ë‰∫Ü‰∏Ä‰∏ã",
        {pause: 700},
        {muted:"Â•πÊ≤°ÊúâÂà†Èô§‰Ω†\nËÅäÂ§©ËÆ∞ÂΩï‰πüËøòÂú®"},
        {danger:"Âè™ÊòØ‰ªéÈÇ£Â§©ÂºÄÂßã\n‰Ω†ÂèëÂá∫ÂéªÁöÑÊØè‰∏ÄÊù°Ê∂àÊÅØ\nÈÉΩÊ≤°ÊúâÂÜçÊî∂Âà∞ÂõûÂ∫î"},
      ]),
      endNote: "ÊúÄÂÜ∑ÁöÑ‰∏çÊòØÂà†Èô§ÔºåÊòØËøòÂú®Ôºå‰ΩÜ‰∏çÂÜçÂìçÂ∫î„ÄÇ",
      nextAfterEnding: "S3_START",
      progress: 66,
    },

    S3_START: {
      scene: 3,
      title: "Scene 3 ¬∑ Ê¥óÊæ°Êó∂ÁöÑÈÇ£Êù°Ê∂àÊÅØ",
      sub: "ËäÇÂ•èÊùÉÈáç ¬∑ Âõû‰∏çÂõû‰∏çÊòØÊÄÅÂ∫¶ÔºåÊòØÊùÉÈáç",
      lines: [
        "‰Ω†Âú®Ê¥óÊæ°",
        "Ê∞¥Â£∞ÁõñËøá‰∫Ü‰∏ÄÂàá",
        {pause: 700},
        {muted:"ÊâãÊú∫ÈúáÂä®‰∫Ü‰∏Ä‰∏ã"},
        "‰Ω†‰ΩéÂ§¥Áúã‰∫Ü‰∏ÄÁúº",
        {em:"ÊòØÂ•π"},
        {pause: 800},
        "‰Ω†ÊÑèËØÜÂà∞",
        "Áé∞Âú®Âõû‰∏çÂõû\n‰∏çÊòØÊÄÅÂ∫¶ÈóÆÈ¢ò",
        "ËÄåÊòØËäÇÂ•èÈóÆÈ¢ò",
      ],
      choices: [
        { key:"A", text:"Êì¶Âπ≤ÊâãÔºåÂÖàÂõûÂ§çÂ•π", next:"S3_END_A3" },
        { key:"B", text:"ÂÅáË£ÖÊ≤°ÁúãËßÅÔºåÂÖàÊ¥óÂÆåÊæ°", next:"S3_END_B3" },
      ],
      progress: 100,
    },

    S3_END_A3: {
      scene: 3, ending: true,
      endTitle: "ÁªìÂ±Ä A3 ¬∑ ËäÇÂ•èÊÖ¢ÊÖ¢ÈáçÂêà",
      endBody: () => renderSystemPanel([
        "‰Ω†Êì¶Âπ≤Êâã\nÂæàÂø´Âõû‰∫ÜÂ•πÁöÑÊ∂àÊÅØ",
        "Â•πÂõûÂ§çÂæóÊØîÂπ≥Êó∂Âø´‰∫Ü‰∏ÄÁÇπ\n‰ΩÜËØ≠Ê∞îÊ≤°ÊúâÂèòÂåñ",
        {muted:"‰Ω†ÊÑüËßâÂæóÂà∞\nÂ•πÂºÄÂßãÂØπ‰Ω†Âä®ÂøÉ\n‰ΩÜÊ≤°ÊúâËØ¥Âá∫Âè£"},
        {ok:"Â•π‰πüÂºÄÂßã\nËæπÂõûÊ∂àÊÅØ\nËæπÂÅöËá™Â∑±ÁöÑ‰∫ãÊÉÖ"},
      ]),
      endNote: "Èù†Ëøë‰∏çÊòØË°®ÁôΩÔºåÊòØËäÇÂ•èÂºÄÂßãÂêåÊ≠•„ÄÇ",
      nextAfterEnding: "THE_END",
      progress: 100,
    },

    S3_END_B3: {
      scene: 3, ending: true,
      endTitle: "ÁªìÂ±Ä B3 ¬∑ ÊùÉÈáç‰∏ãË∞É",
      endBody: () => renderSystemPanel([
        "‰Ω†ÁªßÁª≠Ê¥óÊæ°\nÊ≤°ÊúâÂõûÂ•π",
        "Á≠â‰Ω†Âá∫Êù•ÁöÑÊó∂ÂÄô\nÂ•πÂ∑≤ÁªèÂèë‰∫ÜÂ•ΩÂá†Êù°Ê∂àÊÅØ",
        {muted:"ËØ≠Ê∞î‰æùÊóßÁÉ≠ÊÉÖ\nÊ≤°Êúâ‰∏çÊª°"},
        {danger:"Âè™ÊòØ‰ªéÈÇ£‰πãÂêé\nÂΩìÂ•πÂú®ÂøôÁöÑÊó∂ÂÄô\nÂ•π‰ºö‰∏ãÊÑèËØÜÂ±èËîΩ‰Ω†ÁöÑÊ∂àÊÅØ"},
        {muted:"Áõ¥Âà∞ÂøôÂÆå\nÊâçÂõûÂ§ç‰Ω†"},
      ]),
      endNote: "ÁÉ≠ÊÉÖ‰ªçÂú®Ôºå‰ΩÜ‰Ω†ÁöÑÊ∂àÊÅØ‰∏çÂÜç‰ºòÂÖà„ÄÇ",
      nextAfterEnding: "THE_END",
      progress: 100,
    },

    THE_END: {
      scene: 4,
      title: "Chapter 2 ¬∑ ÁªìÊùü",
      sub: "‰Ω†ÂÅöÁöÑÊØè‰∏ÄÊ≠•ÈÉΩÂêàÁêÜÔºå‰ΩÜÁªìÂ±Ä‰∏çÁî±ÈÄâÊã©‰øùËØÅ",
      lines: [
        {sys:"[Á≥ªÁªüÊèêÁ§∫] Êú¨Á´†ËäÇÂ∑≤ÁªìÊùü"},
        "‰Ω†ÂÅöÁöÑÊØè‰∏Ä‰∏™ÈÄâÊã©\nÈÉΩÂæàÂêàÁêÜ",
        "Âè™ÊòØÊúâ‰∫õÂÖ≥Á≥ª\n‰ªé‰∏ÄÂºÄÂßã\nÂ∞±‰∏ç‰∫§ÁªôÈÄâÊã©Êù•ÂÜ≥ÂÆö",
      ],
      choices: [
        { key:"‚Ü∫", text:"ÂÜçÁé©‰∏ÄÊ¨°Ôºà‰ªéÂ§¥Ôºâ", next:"S1_START" },
      ],
      progress: 100,
    },
  };

  function setProgress(pct){ $('bar').style.width = `${pct}%`; }

  function setHeader(node){
    $('sceneTitle').textContent = node.title || `Scene ${node.scene}`;
    $('sceneSub').textContent = node.sub || "";
    setProgress(node.progress ?? 0);
  }

  function clearLines(){ $('lines').innerHTML = ""; }

  function vibrate(ms=15){
    try{ if (navigator.vibrate) navigator.vibrate(ms); }catch(_){}
  }

  function wait(ms){ return new Promise(r => setTimeout(r, ms)); }

  function addLine(text, cls=""){
    const div = document.createElement('div');
    div.className = `line ${cls}`.trim();
    div.textContent = text;
    $('lines').appendChild(div);

    requestAnimationFrame(() => {
      div.classList.add('show');
      const dlg = document.querySelector('.card.dialogue');
      dlg.scrollTop = dlg.scrollHeight;
    });
  }

  async function playLines(lines){
    isTyping = true;
    cancelToken.cancelled = false;

    for (const item of lines){
      if (cancelToken.cancelled) break;

      if (typeof item === "string"){
        addLine(item);
        await wait(game.fast ? 0 : 320);
        continue;
      }
      if (item.pause){
        await wait(game.fast ? 0 : item.pause);
      } else if (item.muted){
        addLine(item.muted, "muted");
        await wait(game.fast ? 0 : 320);
      } else if (item.sys){
        addLine(item.sys, "sys");
        await wait(game.fast ? 0 : 320);
      } else if (item.em){
        addLine(item.em, "em");
        await wait(game.fast ? 0 : 320);
      } else if (item.danger){
        addLine(item.danger, "em");
        document.querySelector('.phone').classList.add('shake');
        vibrate(30);
        await wait(420);
        document.querySelector('.phone').classList.remove('shake');
      } else if (item.ok){
        addLine(item.ok, "muted");
        await wait(game.fast ? 0 : 320);
      }
    }

    isTyping = false;
  }

  function escapeHTML(s){
    return String(s)
      .replaceAll("&","&amp;")
      .replaceAll("<","&lt;")
      .replaceAll(">","&gt;")
      .replaceAll('"',"&quot;")
      .replaceAll("'","&#39;");
  }

  function renderChoices(choices){
    const box = $('choices');
    box.innerHTML = "";
    for (const c of choices){
      const btn = document.createElement('button');
      btn.className = "btn";
      btn.innerHTML = `<span class="tag">${escapeHTML(c.key)}</span>${escapeHTML(c.text)}`;
      btn.onclick = () => onChoose(btn, c);
      box.appendChild(btn);
    }
  }

  function lockOtherButtons(activeBtn){
    [...$('choices').querySelectorAll('.btn')].forEach(b => {
      if (b !== activeBtn) b.classList.add('fade');
      else b.classList.add('disabled');
    });
  }

  function showOverlay(title, bodyNode, note){
    $('endTitle').textContent = title || "ÁªìÂ±Ä";
    const endBody = $('endBody');
    endBody.innerHTML = "";
    endBody.appendChild(bodyNode);
    $('endNote').textContent = note || "";
    $('overlay').classList.add('show');
  }

  function hideOverlay(){ $('overlay').classList.remove('show'); }

  function renderChatFail(){
    const wrap = document.createElement('div');
    wrap.className = "chat";

    const top = document.createElement('div');
    top.className = "chatTop";
    top.innerHTML = `<span class="excl"><span class="badgeDanger">!</span> Á∫¢Ëâ≤ÊÑüÂèπÂè∑</span><span>ÂèëÈÄÅÂ§±Ë¥•</span>`;
    wrap.appendChild(top);

    const them = document.createElement('div');
    them.className = "msg them";
    them.textContent = "Êä±Ê≠â„ÄÇ";
    wrap.appendChild(them);

    const me = document.createElement('div');
    me.className = "msg me";
    me.textContent = "Êó©ÂÆâ";
    wrap.appendChild(me);

    const sys = document.createElement('div');
    sys.className = "small";
    sys.style.marginTop = "6px";
    sys.style.color = "rgba(255,255,255,.55)";
    sys.textContent = "Á≥ªÁªüÊèêÁ§∫ÔºöÊ∂àÊÅØÂèëÈÄÅÂ§±Ë¥•";
    wrap.appendChild(sys);

    return wrap;
  }

  function renderCallScene(name, lines){
    const card = document.createElement('div');
    card.className = "call";

    const av = document.createElement('div');
    av.className = "avatar";
    av.textContent = "‚òé";
    card.appendChild(av);

    const meta = document.createElement('div');
    meta.style.textAlign = "center";
    meta.innerHTML = `<div style="font-weight:750">${escapeHTML(name)}</div><div class="small">ÈÄöËØù‰∏≠ <span class="ring"></span></div>`;
    card.appendChild(meta);

    const text = document.createElement('div');
    text.style.width = "100%";
    text.style.display = "grid";
    text.style.gap = "8px";
    text.style.marginTop = "8px";

    lines.forEach(s => {
      const p = document.createElement('div');
      p.className = "msg them";
      p.style.maxWidth = "100%";
      p.style.background = "rgba(255,255,255,.06)";
      p.textContent = String(s);
      text.appendChild(p);
    });

    card.appendChild(text);
    return card;
  }

  function renderSystemPanel(lines){
    const box = document.createElement('div');
    box.style.display = "grid";
    box.style.gap = "10px";

    lines.forEach(item => {
      if (typeof item === "string"){
        const d = document.createElement('div');
        d.className = "msg them";
        d.style.maxWidth = "100%";
        d.style.background = "rgba(255,255,255,.06)";
        d.textContent = item;
        box.appendChild(d);
        return;
      }
      if (item.pause) return;

      const d = document.createElement('div');
      d.className = "msg them";
      d.style.maxWidth = "100%";
      d.style.background = "rgba(255,255,255,.06)";

      if (item.danger){
        d.style.borderColor = "rgba(255,77,79,.35)";
        d.style.background = "rgba(255,77,79,.10)";
        d.textContent = item.danger;
      } else if (item.ok){
        d.style.borderColor = "rgba(52,211,153,.30)";
        d.style.background = "rgba(52,211,153,.10)";
        d.textContent = item.ok;
      } else if (item.muted){
        d.style.opacity = ".86";
        d.textContent = item.muted;
      } else {
        d.textContent = JSON.stringify(item);
      }
      box.appendChild(d);
    });

    return box;
  }

  async function goto(nodeId){
    game.nodeId = nodeId;
    const node = nodes[nodeId];
    if (!node) return;

    setHeader(node);
    clearLines();
    $('choices').innerHTML = "";

    const dlg = document.querySelector('.card.dialogue');
    dlg.scrollTop = 0;

    if (node.ending){
      await wait(game.fast ? 0 : 160);
      showOverlay(node.endTitle, node.endBody(), node.endNote);
      return;
    }

    await playLines(node.lines || []);
    renderChoices(node.choices || []);
  }

  async function onChoose(btn, choice){
    // ‚úÖËøôÈáå‰πüÈ°∫‰æøËß¶Âèë‰∏ÄÊ¨°Â∞ùËØïÊí≠ÊîæÔºà‰∏çÊîπÂèòÈÄªËæëÔºåÂè™ÊòØÊõ¥Á®≥Ôºâ
    if (musicEnabled2) tryPlayMusic2();

    if (isTyping) return;
    lockOtherButtons(btn);
    vibrate(18);
    await wait(150);
    await goto(choice.next);
  }

  $('continueBtn').onclick = async () => {
    const node = nodes[game.nodeId];
    hideOverlay();
    await wait(120);
    if (node && node.nextAfterEnding){
      await goto(node.nextAfterEnding);
    }
  };

  $('restartBtn').onclick = async () => {
    game.fast = false;
    $('skipBtn').textContent = "Âø´ÈÄüË∑≥ËøáÊñáÂ≠ó";
    hideOverlay();
    await goto("S1_START");
  };

  $('skipBtn').onclick = () => {
    game.fast = !game.fast;
    $('skipBtn').textContent = game.fast ? "ÊÅ¢Â§çÊ≠£Â∏∏ÈÄüÂ∫¶" : "Âø´ÈÄüË∑≥ËøáÊñáÂ≠ó";

    if (isTyping){
      cancelToken.cancelled = true;
      const cur = nodes[game.nodeId];
      if (cur && !cur.ending){
        setTimeout(() => goto(game.nodeId), 0);
      }
    }
  };

  goto("S1_START");
})();
</script>
</body>
</html>
