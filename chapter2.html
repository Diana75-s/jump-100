<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>Chapter 2 Â· å‰§æƒ…é€‰æ‹©</title>
  <style>
    :root{
      /* âœ… è—è“æ¸å˜ï¼ˆæ›´ç»Ÿä¸€ï¼‰ */
      --bg1:#071022;
      --bg2:#0a1633;
      --bg3:#0b1e3f;

      --card:rgba(255,255,255,.08);
      --card2:rgba(255,255,255,.12);
      --ink:rgba(255,255,255,.92);
      --muted:rgba(255,255,255,.68);
      --muted2:rgba(255,255,255,.46);

      --accent:#7dd3fc;
      --danger:#ff4d4f;
      --ok:#34d399;

      --shadow:0 18px 60px rgba(0,0,0,.45);
      --radius:22px;
    }
    *{box-sizing:border-box}
    html,body{height:100%;margin:0}
    body{
      background:
        radial-gradient(1000px 700px at 25% 10%, rgba(125,211,252,.14) 0%, transparent 60%),
        radial-gradient(900px 650px at 80% 60%, rgba(52,211,153,.10) 0%, transparent 55%),
        linear-gradient(180deg, var(--bg3), var(--bg2) 45%, var(--bg1));
      color:var(--ink);
      font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Helvetica,Arial,"PingFang SC","Noto Sans SC","Microsoft YaHei",sans-serif;
      overflow:hidden;
    }

    /* âœ… å¤–å±‚ï¼šsvh å…œåº• + dvh ä¼˜å…ˆï¼Œé¿å… iOS åœ°å€æ é«˜åº¦æŠ–åŠ¨ */
    .wrap{
      height:100svh;
      height:100dvh;
      display:flex;
      align-items:center;
      justify-content:center;
      padding:18px;
    }
    /* iOS æ—§ç‰ˆæœ¬å…œåº• */
    @supports (-webkit-touch-callout: none) {
      .wrap{ height:-webkit-fill-available; }
    }

    .phone{
      width:min(420px, 100%);
      height:min(860px, calc(100svh - 36px));
      height:min(860px, calc(100dvh - 36px)); /* âœ… dvh ä¼˜å…ˆ */
      background:rgba(0,0,0,.22);
      border:1px solid rgba(255,255,255,.10);
      border-radius:34px;
      box-shadow: var(--shadow);
      position:relative;
      overflow:hidden;
      backdrop-filter: blur(10px);
    }

    /* âœ… å…³é”®ä¿®å¤ï¼šsafe ä¸å†è£åˆ‡åº•éƒ¨ï¼ˆä¸æ»šåŠ¨ï¼‰ï¼Œè®© stage å»æ»šåŠ¨ */
    .safe{
      padding: max(14px, env(safe-area-inset-top)) 16px max(14px, env(safe-area-inset-bottom)) 16px;
      height:100%;
      display:flex;
      flex-direction:column;
      gap:12px;
      min-height:0;
      overflow:hidden; /* âœ… é˜²æ­¢æ•´ä½“æº¢å‡ºè¢« phone è£åˆ‡æ—¶æ— æ³•æ»šåŠ¨ï¼šç”± stage æ»šåŠ¨è§£å†³ */
    }

    .topbar{
      display:flex; align-items:center; justify-content:space-between;
      font-size:12px; color:var(--muted2);
      letter-spacing:.2px;
      flex:0 0 auto;
      gap:10px;
    }
    .pill{
      background:rgba(255,255,255,.08);
      border:1px solid rgba(255,255,255,.12);
      padding:8px 10px;
      border-radius:999px;
      display:inline-flex; gap:8px; align-items:center;
      user-select:none;
      -webkit-tap-highlight-color: transparent;
    }
    .dot{width:6px;height:6px;border-radius:50%;background:var(--accent); box-shadow:0 0 18px rgba(125,211,252,.6)}

    /* âœ… éŸ³ä¹å¼€å…³ï¼šå†…åµŒ pillï¼ˆä¸åšé¢å¤–æŒ‰é’®è®¾è®¡ï¼‰ */
    .pillToggle{cursor:pointer}
    .pillToggle:active{transform: translateY(1px)}
    .pillToggle .ic{opacity:.9}

    /* âœ… stage å˜æˆæ»šåŠ¨å®¹å™¨ï¼šå°å±æ—¶ä¸ä¼šé®æŒ¡ choices/footer */
    .stage{
      flex:1 1 auto;
      min-height:0;
      display:flex;
      flex-direction:column;
      gap:12px;
      position:relative;

      overflow:auto;                    /* âœ… è®© stage è‡ªå·±æ»š */
      -webkit-overflow-scrolling: touch;
      padding-bottom: 10px;             /* âœ… é¿å…æœ€åä¸€å—è´´æ­» */
    }

    .header{
      display:flex; align-items:flex-end; justify-content:space-between; gap:10px;
      flex:0 0 auto;
    }
    .title{
      font-size:18px; font-weight:750; letter-spacing:.2px;
      color:rgba(255,255,255,.94);
    }
    .subtitle{font-size:12px;color:var(--muted2)}
    .progress{
      height:8px; width:120px; border-radius:999px;
      background:rgba(255,255,255,.12);
      overflow:hidden;
    }
    .bar{
      height:100%; width:0%;
      background:linear-gradient(90deg, rgba(125,211,252,.92), rgba(52,211,153,.88));
      border-radius:999px;
      transition: width 600ms ease;
    }

    .card{
      background:var(--card);
      border:1px solid rgba(255,255,255,.12);
      border-radius: var(--radius);
      padding:14px 14px;
      box-shadow: 0 10px 30px rgba(0,0,0,.25);
    }

    /* âœ… å¯¹è¯æ¡†ä»ç„¶å†…éƒ¨æ»šåŠ¨ï¼Œä½†é»˜è®¤ä¸ä¼šæŒ¤çˆ†æ•´ä½“ï¼ˆé…åˆ stage æ»šåŠ¨æ›´ç¨³ï¼‰ */
    .card.dialogue{
      flex:1 1 auto;
      min-height:120px;                 /* âœ… ç»™ä¸ªä¸‹é™ï¼Œé¿å…æç«¯å°å±å‹æ‰ */
      overflow:auto;
      -webkit-overflow-scrolling: touch;
    }
    .lines{
      display:flex; flex-direction:column; gap:8px;
      min-height:0;
      padding-bottom:6px;
    }

    .line{
      opacity:0;
      transform: translateY(10px);
      transition: opacity 420ms ease, transform 420ms ease;
      color:rgba(255,255,255,.92);
      line-height:1.58;
      font-size:15px;
      white-space:pre-wrap;
    }
    .line.show{opacity:1; transform: translateY(0)}
    .line.muted{color:var(--muted)}
    .line.sys{color:var(--muted2); font-size:13px}
    .line.em{color:var(--accent); font-weight:650}

    .choices{display:grid; gap:10px}
    .btn{
      width:100%;
      border-radius:16px;
      padding:12px 12px;
      border:1px solid rgba(255,255,255,.16);
      background:rgba(255,255,255,.08);
      color:rgba(255,255,255,.92);
      font-size:15px;
      text-align:left;
      cursor:pointer;
      transition: transform 120ms ease, background 240ms ease, border-color 240ms ease, opacity 240ms ease;
      user-select:none;
      -webkit-tap-highlight-color: transparent;
      position:relative;
      overflow:hidden;
    }
    .btn:hover{background:rgba(255,255,255,.12)}
    .btn:active{transform: translateY(1px) scale(.99)}
    .btn .tag{
      display:inline-flex; align-items:center; justify-content:center;
      width:26px; height:26px; border-radius:10px;
      margin-right:10px;
      font-weight:800;
      background:rgba(125,211,252,.12);
      border:1px solid rgba(125,211,252,.20);
      color:rgba(125,211,252,.95);
      font-size:13px;
    }
    .btn.disabled{opacity:.45; pointer-events:none}
    .btn.fade{opacity:.22; filter: blur(.2px)}
    .btn::after{
      content:"";
      position:absolute; inset:-40%;
      background: radial-gradient(circle at 20% 20%, rgba(255,255,255,.16), transparent 55%);
      transform: rotate(12deg);
      opacity:0;
      transition: opacity 240ms ease;
    }
    .btn:hover::after{opacity:1}

    .overlay{
      position:absolute; inset:0;
      display:flex; align-items:center; justify-content:center;
      background:rgba(0,0,0,.55);
      backdrop-filter: blur(8px);
      opacity:0; pointer-events:none;
      transition: opacity 360ms ease;
      padding:18px;
      z-index:20;
    }
    .overlay.show{opacity:1; pointer-events:auto}
    .panel{
      width:100%;
      max-width: 380px;
      background:rgba(10,14,24,.78);
      border:1px solid rgba(255,255,255,.12);
      border-radius: 26px;
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .panelHead{
      padding:14px 14px;
      border-bottom:1px solid rgba(255,255,255,.10);
      display:flex; align-items:center; justify-content:space-between;
      gap:10px;
    }
    .panelHead .h{font-weight:750}
    .panelBody{padding:14px 14px}
    .small{font-size:12px;color:var(--muted2)}

    .chat{
      background:rgba(255,255,255,.06);
      border:1px solid rgba(255,255,255,.10);
      border-radius: 20px;
      padding:12px;
      display:flex; flex-direction:column; gap:10px;
    }
    .msg{
      max-width: 82%;
      padding:10px 12px;
      border-radius: 16px;
      font-size:14px;
      line-height:1.4;
      border:1px solid rgba(255,255,255,.10);
      background:rgba(255,255,255,.08);
      color:rgba(255,255,255,.92);
    }
    .msg.me{align-self:flex-end; background:rgba(125,211,252,.10); border-color:rgba(125,211,252,.18)}
    .msg.them{align-self:flex-start}
    .chatTop{
      display:flex; align-items:center; justify-content:space-between;
      color:var(--muted2);
      font-size:12px;
      margin-bottom:2px;
    }
    .excl{
      display:inline-flex; align-items:center; gap:8px;
      color: rgba(255,255,255,.85);
    }
    .badgeDanger{
      width:16px;height:16px;border-radius:50%;
      background:var(--danger);
      display:inline-flex; align-items:center; justify-content:center;
      color:#fff; font-weight:900; font-size:12px;
      box-shadow:0 0 18px rgba(255,77,79,.45);
    }

    .call{
      display:flex; flex-direction:column; align-items:center; justify-content:center;
      gap:12px; padding:18px;
    }
    .avatar{
      width:84px;height:84px;border-radius:28px;
      background:rgba(125,211,252,.10);
      border:1px solid rgba(125,211,252,.20);
      display:flex; align-items:center; justify-content:center;
      font-weight:900;
      color:rgba(125,211,252,.95);
      font-size:24px;
      box-shadow:0 0 30px rgba(125,211,252,.15);
      transform: translateZ(0);
      animation: floaty 2.6s ease-in-out infinite;
    }
    @keyframes floaty{ 0%,100%{transform:translateY(0)} 50%{transform:translateY(-6px)} }
    .ring{
      width:10px;height:10px;border-radius:50%;
      background:var(--ok);
      box-shadow:0 0 18px rgba(52,211,153,.55);
    }
    .shake{ animation: shake 420ms ease; }
    @keyframes shake{
      0%,100%{transform:translateX(0)}
      20%{transform:translateX(-6px)}
      40%{transform:translateX(6px)}
      60%{transform:translateX(-4px)}
      80%{transform:translateX(4px)}
    }

    /* âœ… footer æ°¸è¿œå¯è§ï¼šsticky è´´åº• */
    .footer{
      display:flex; justify-content:space-between; align-items:center; gap:10px;
      flex:0 0 auto;

      position: sticky;
      bottom: 0;
      z-index: 5;

      padding-top: 10px;
      background: linear-gradient(180deg, rgba(10,22,51,0), rgba(10,22,51,.55) 35%, rgba(7,16,34,.85));
      backdrop-filter: blur(8px);
    }

    .linkbtn{
      background:transparent;
      border:1px solid rgba(255,255,255,.16);
      color:var(--muted);
      border-radius:14px;
      padding:10px 12px;
      cursor:pointer;
      transition: background 200ms ease, transform 120ms ease;
    }
    .linkbtn:hover{background:rgba(255,255,255,.06)}
    .linkbtn:active{transform: translateY(1px)}
    .primary{
      border-color: rgba(125,211,252,.28);
      color: rgba(125,211,252,.95);
    }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="phone">

      <!-- âœ… BGM2ï¼šæŠŠ bgm2.mp3 æ”¾åˆ° chapter2.html åŒç›®å½• -->
      <audio id="bgm2" src="bgm2.mp3" preload="auto" loop></audio>

      <div class="safe">
        <div class="topbar">
          <div class="pill"><span class="dot"></span><span id="modeText">Chapter 2 Â· å‰§æƒ…é€‰æ‹©</span></div>

          <!-- âœ… å³ä¾§ï¼šéŸ³ä¹å¼€å…³ï¼ˆå†…åµŒï¼‰ + æ—¶é’Ÿ -->
          <div style="display:flex; gap:10px; align-items:center;">
            <div class="pill pillToggle" id="btnMusic2" role="button" aria-label="music toggle">
              <span class="ic" id="musicIc2">ğŸ”ˆ</span><span id="musicText2">éŸ³ä¹ï¼šå…³</span>
            </div>
            <div class="pill"><span id="clock">--:--</span></div>
          </div>
        </div>

        <div class="stage">
          <div class="header">
            <div>
              <div class="title" id="sceneTitle">Scene 1 Â· é‚£é€šç”µè¯ä¹‹å</div>
              <div class="subtitle" id="sceneSub">åƒåƒè§†è§’ Â· ä½ è¿˜æœ‰ä¸€å¥è¯æ²¡è¯´å®Œ</div>
            </div>
            <div class="progress" aria-label="progress">
              <div class="bar" id="bar"></div>
            </div>
          </div>

          <div class="card dialogue">
            <div class="lines" id="lines"></div>
          </div>

          <div class="card">
            <div class="choices" id="choices"></div>
          </div>
        </div>

        <div class="footer">
          <button class="linkbtn" id="restartBtn">é‡æ¥</button>
          <button class="linkbtn primary" id="skipBtn">å¿«é€Ÿè·³è¿‡æ–‡å­—</button>
        </div>
      </div>

      <!-- ending overlay -->
      <div class="overlay" id="overlay">
        <div class="panel">
          <div class="panelHead">
            <div class="h" id="endTitle">ç»“å±€</div>
            <button class="linkbtn" id="continueBtn">ç»§ç»­</button>
          </div>
          <div class="panelBody" id="endBody"></div>
          <div class="panelBody small" id="endNote"></div>
        </div>
      </div>

    </div>
  </div>

<script>
(() => {
  const $ = (id) => document.getElementById(id);

  /* ========= BGM2ï¼ˆä¿®å¤æ— å£°ï¼šå¿…é¡»ç”¨æˆ·æ‰‹åŠ¿è§¦å‘ï¼‰ ========= */
  const bgm2 = $('bgm2');
  const btnMusic2 = $('btnMusic2');
  const musicText2 = $('musicText2');
  const musicIc2 = $('musicIc2');
  let musicEnabled2 = false;

  // âœ… é¿å…è¢«æµè§ˆå™¨ç»§æ‰¿é™éŸ³/éå†…è”æ’­æ”¾ç­–ç•¥
  try{
    bgm2.preload = "auto";
    bgm2.loop = true;
    bgm2.muted = false;
    bgm2.volume = 1;
    bgm2.playsInline = true;
    bgm2.setAttribute("playsinline","");
    bgm2.setAttribute("webkit-playsinline","");
  }catch(_){}

  function setMusicBtn2(){
    musicText2.textContent = musicEnabled2 ? "éŸ³ä¹ï¼šå¼€" : "éŸ³ä¹ï¼šå…³";
    musicIc2.textContent = musicEnabled2 ? "ğŸ”Š" : "ğŸ”ˆ";
  }
  setMusicBtn2();

  async function tryPlayMusic2(){
    if (!musicEnabled2) return;
    try{ await bgm2.play(); }catch(e){}
  }

  function stopMusic2(){
    try{ bgm2.pause(); }catch(e){}
  }

  btnMusic2.addEventListener('click', async () => {
    musicEnabled2 = !musicEnabled2;
    setMusicBtn2();
    if (musicEnabled2) await tryPlayMusic2();
    else stopMusic2();
  });

  // âœ… ä»»æ„ç”¨æˆ·æ‰‹åŠ¿è§¦å‘ä¸€æ¬¡æ’­æ”¾ï¼ˆå¦‚æœå·²ç»å¼€äº†éŸ³ä¹ï¼‰
  function onAnyUserGesture(){
    if (musicEnabled2) tryPlayMusic2();
  }
  window.addEventListener('pointerdown', onAnyUserGesture, {passive:true});
  window.addEventListener('touchstart', onAnyUserGesture, {passive:true});

  /* ========= clock ========= */
  function tickClock(){
    const d = new Date();
    const hh = String(d.getHours()).padStart(2,'0');
    const mm = String(d.getMinutes()).padStart(2,'0');
    $('clock').textContent = `${hh}:${mm}`;
  }
  tickClock(); setInterval(tickClock, 10000);

  /* ========= data ========= */
  const game = { nodeId: "S1_START", fast: false };
  let isTyping = false;
  let cancelToken = { cancelled:false };

  /* âœ… å‰§æƒ…ï¼šæŒ‰ä½ åŸæ–‡ä¸€å­—ä¸åŠ¨ï¼ˆScene1/2/3 + ç»“å±€ + THE_END å…¨ä¿ç•™ï¼‰ */
  const nodes = {
    // Scene 1
    S1_START: {
      scene: 1,
      title: "Scene 1 Â· é‚£é€šç”µè¯ä¹‹å",
      sub: "åƒåƒè§†è§’ Â· ä½ è¿˜æœ‰ä¸€å¥è¯æ²¡è¯´å®Œ",
      lines: [
        "ç”µè¯æŒ‚æ–­äº†",
        "ä½ åˆšåˆš\næŠŠè‡ªå·±ä»å°åˆ°å¤§çš„ç»å†\nä¸€è‚¡è„‘åœ°è¯´å®Œ",
        "ä½ è¯´\nä¸ç®¡ä»¥ä»€ä¹ˆå…³ç³»\néƒ½å¸Œæœ›ä»¥åè¿˜èƒ½ç»§ç»­ç›¸å¤„",
        {pause: 1000},
        "æ‰‹æœºåˆäº®äº†ä¸€ä¸‹",
        {em: "å¥¹å‘æ¥ä¸€å¥\næ™šå®‰"},
        {pause: 800},
        "ä½ ç›¯ç€é‚£ä¸¤ä¸ªå­—\nçœ‹äº†ä¸€ä¼šå„¿",
        "ä½ çªç„¶æƒ³èµ·\nè¿‡å»çš„ä¸€æ®µç»å†",
        "é‚£ä¸€æ¬¡\nä½ ä¹Ÿæ˜¯è¿™æ ·\nè¯è¯´åˆ°ä¸€åŠ\nå°±è¢«ä¸€å¥\nçœ‹èµ·æ¥å¾ˆæ­£å¸¸çš„è¯\nç»“æŸäº†",
        "ä½ æ„è¯†åˆ°\nä½ è¿˜æœ‰ä¸€å¥è¯\næ²¡æœ‰è¯´å®Œ",
        "é‚£å¥è¯\nå¦‚æœç°åœ¨ä¸è¯´\nå¯èƒ½å°±å†ä¹Ÿæ²¡æœ‰æœºä¼šäº†",
      ],
      choices: [
        { key:"A", text:"æ´—æ¼±å¥½ï¼Œä¼‘æ¯", next:"S1_END_A1" },
        { key:"B", text:"å†æ‰“ä¸€ä¸ªç”µè¯ç»™è«æ–¯ç§‘çš„å°çŸ®äºº", next:"S1_END_B1" },
      ],
      progress: 33,
    },

    S1_END_A1: {
      scene: 1,
      ending: true,
      endTitle: "ç»“å±€ A1 Â· æ¶ˆæ¯å‘é€å¤±è´¥",
      endBody: () => renderChatFail(),
      endNote: "ä½ æ²¡æœ‰åšé”™ã€‚\nåªæ˜¯æœ‰äº›æ²‰é»˜ä¼šæˆä¸ºæœ€åä¸€æ¬¡ã€‚",
      nextAfterEnding: "S2_START",
      progress: 33,
    },

    S1_END_B1: {
      scene: 1,
      ending: true,
      endTitle: "ç»“å±€ B1 Â· å¼ºè¡Œç»­å‘½",
      endBody: () => renderCallScene("è«æ–¯ç§‘çš„å°çŸ®äºº", [
        "å¥¹å‡ ä¹æ˜¯æ…Œä¹±åœ°æ¥èµ·äº†ç”µè¯",
        "é—®ä½ ï¼šæ€ä¹ˆäº†",
        "ä½ è¯­æ°”å˜å¾—å¾ˆè®¤çœŸ",
        "ä½ è¯´ï¼šæ— è®ºå¦‚ä½•\nä¸å¯ä»¥åˆ é™¤æˆ‘",
        "ä½ å¸Œæœ›\næ˜å¤©è¿˜èƒ½ç»§ç»­èŠå¤©",
        "å¥¹æ²‰é»˜äº†ä¸€ä¸‹\nç„¶åç­”åº”äº†",
        "ç”µè¯æŒ‚æ–­\nå¤œé‡æ–°å®‰é™ä¸‹æ¥",
      ]),
      endNote: "ä½ æŠŠè¯è¯´å®Œäº†ã€‚\nä½†ç»“å±€ä»ä¸ä¿è¯ç”±ä½ å†³å®šã€‚",
      nextAfterEnding: "S2_START",
      progress: 33,
    },

    // Scene 2
    S2_START: {
      scene: 2,
      title: "Scene 2 Â· å¥¹å“­çš„æ—¶å€™",
      sub: "ä»·å€¼ç«™ä½ Â· ä½ çŸ¥é“è¿™ä¼šæ”¹å˜å¥¹çœ‹ä½ çš„æ–¹å¼",
      lines: [
        "å¥¹å¼€å§‹è·Ÿä½ è¯´\nå¥¹å’Œå‰ä»»åˆ†æ‰‹çš„åŸå› ",
        "ä¸æ˜¯æŸä¸€ä»¶å…·ä½“çš„äº‹",
        "è€Œæ˜¯\nä¸€æ¬¡æ¬¡å…³äºç”·å¥³å¯¹ç«‹çš„äº‰åµ",
        "å¥¹è¯´\nå¥¹åªæ˜¯æƒ³è¢«ç†è§£",
        "ä½†æ¯ä¸€æ¬¡è®¨è®º\næœ€åéƒ½ä¼šå˜æˆ\nè°ç«™åœ¨å“ªä¸€è¾¹",
        "è¯´ç€è¯´ç€\nå¥¹å“­äº†",
        "ä½ æ„è¯†åˆ°\nå¥¹ä¸æ˜¯åœ¨é—®ä½ \nè°å¯¹è°é”™",
        "å¥¹åªæ˜¯\næœ‰ç‚¹æ’‘ä¸ä½äº†",
        {pause: 900},
        {muted:"ä½ çŸ¥é“\nä¸ç®¡ä½ æ¥ä¸‹æ¥æ€ä¹ˆå›åº”\néƒ½ä¼šæ”¹å˜\nå¥¹çœ‹ä½ çš„æ–¹å¼"},
      ],
      choices: [
        { key:"A", text:"å…ˆç«™åœ¨å¥¹è¿™è¾¹", next:"S2_END_A2" },
        { key:"B", text:"å…ˆå¬æ¸…æ¥šï¼Œå†åˆ†æ", next:"S2_END_B2" },
        { key:"C", text:"ç›´è¯´ä½ ä¸åŒæ„å¥¹çš„çœ‹æ³•", next:"S2_END_C2" },
      ],
      progress: 66,
    },

    S2_END_A2: {
      scene: 2, ending: true,
      endTitle: "ç»“å±€ A2 Â· è¢«ç†è§£ï¼Œä½†ä¸è¢«ä¿¡ä»»",
      endBody: () => renderSystemPanel([
        "ä½ æ²¡æœ‰æ‰“æ–­å¥¹",
        "ä½ é¡ºç€å¥¹çš„è¯\nä¸€å¥ä¸€å¥å®‰æ…°",
        "å¥¹æ„£äº†ä¸€ä¸‹",
        "ç„¶åå¥¹çªç„¶æ„è¯†åˆ°\nä½ æ²¡æœ‰åœ¨æƒ³",
        "ä½ åªæ˜¯åœ¨\né™ªå¥¹è¯´è¯",
        {danger:"å¥¹é€‰æ‹©æ‹‰é»‘ä½ "},
      ]),
      endNote: "æƒ…ç»ªå¯¹é½æœ‰æ—¶ä¼šè¢«è¯¯è¯»ä¸ºæ•·è¡ã€‚",
      nextAfterEnding: "S3_START",
      progress: 66,
    },

    S2_END_B2: {
      scene: 2, ending: true,
      endTitle: "ç»“å±€ B2 Â· è¢«å°Šé‡ï¼Œä½†è·ç¦»æ‹‰å¼€",
      endBody: () => renderSystemPanel([
        "ä½ è®©å¥¹æ…¢æ…¢è¯´\næ²¡æœ‰æ€¥ç€å›åº”",
        "ç­‰å¥¹è¯´å®Œ\nä½ æ‰å¼€å§‹åˆ†æ",
        "å¥¹å¬å¾—å¾ˆè®¤çœŸ",
        "æ²¡æœ‰åé©³\nä¹Ÿæ²¡æœ‰è¡¨ç¤ºèµåŒ",
        {muted:"å¥¹ä¾æ—§å…³å¿ƒ\nä½†ä¸å†é è¿‘"},
        {ok:"å¥¹ä¿ç•™äº†ä½ çš„è”ç³»æ–¹å¼"},
      ]),
      endNote: "æ­£ç¡®ä¸ç­‰äºé è¿‘ã€‚",
      nextAfterEnding: "S3_START",
      progress: 66,
    },

    S2_END_C2: {
      scene: 2, ending: true,
      endTitle: "ç»“å±€ C2 Â· é™é»˜ä¸å›",
      endBody: () => renderSystemPanel([
        "ä½ è¯´å‡ºäº†ä½ çš„çœŸå®æƒ³æ³•",
        "å¥¹æ²¡æœ‰åé©³\nåªæ˜¯ç¬‘äº†ä¸€ä¸‹",
        {pause: 700},
        {muted:"å¥¹æ²¡æœ‰åˆ é™¤ä½ \nèŠå¤©è®°å½•ä¹Ÿè¿˜åœ¨"},
        {danger:"åªæ˜¯ä»é‚£å¤©å¼€å§‹\nä½ å‘å‡ºå»çš„æ¯ä¸€æ¡æ¶ˆæ¯\néƒ½æ²¡æœ‰å†æ”¶åˆ°å›åº”"},
      ]),
      endNote: "æœ€å†·çš„ä¸æ˜¯åˆ é™¤ï¼Œæ˜¯è¿˜åœ¨ï¼Œä½†ä¸å†å“åº”ã€‚",
      nextAfterEnding: "S3_START",
      progress: 66,
    },

    // Scene 3
    S3_START: {
      scene: 3,
      title: "Scene 3 Â· æ´—æ¾¡æ—¶çš„é‚£æ¡æ¶ˆæ¯",
      sub: "èŠ‚å¥æƒé‡ Â· å›ä¸å›ä¸æ˜¯æ€åº¦ï¼Œæ˜¯æƒé‡",
      lines: [
        "ä½ åœ¨æ´—æ¾¡",
        "æ°´å£°ç›–è¿‡äº†ä¸€åˆ‡",
        {pause: 700},
        {muted:"æ‰‹æœºéœ‡åŠ¨äº†ä¸€ä¸‹"},
        "ä½ ä½å¤´çœ‹äº†ä¸€çœ¼",
        {em:"æ˜¯å¥¹"},
        {pause: 800},
        "ä½ æ„è¯†åˆ°",
        "ç°åœ¨å›ä¸å›\nä¸æ˜¯æ€åº¦é—®é¢˜",
        "è€Œæ˜¯èŠ‚å¥é—®é¢˜",
      ],
      choices: [
        { key:"A", text:"æ“¦å¹²æ‰‹ï¼Œå…ˆå›å¤å¥¹", next:"S3_END_A3" },
        { key:"B", text:"å‡è£…æ²¡çœ‹è§ï¼Œå…ˆæ´—å®Œæ¾¡", next:"S3_END_B3" },
      ],
      progress: 100,
    },

    S3_END_A3: {
      scene: 3, ending: true,
      endTitle: "ç»“å±€ A3 Â· èŠ‚å¥æ…¢æ…¢é‡åˆ",
      endBody: () => renderSystemPanel([
        "ä½ æ“¦å¹²æ‰‹\nå¾ˆå¿«å›äº†å¥¹çš„æ¶ˆæ¯",
        "å¥¹å›å¤å¾—æ¯”å¹³æ—¶å¿«äº†ä¸€ç‚¹\nä½†è¯­æ°”æ²¡æœ‰å˜åŒ–",
        {muted:"ä½ æ„Ÿè§‰å¾—åˆ°\nå¥¹å¼€å§‹å¯¹ä½ åŠ¨å¿ƒ\nä½†æ²¡æœ‰è¯´å‡ºå£"},
        {ok:"å¥¹ä¹Ÿå¼€å§‹\nè¾¹å›æ¶ˆæ¯\nè¾¹åšè‡ªå·±çš„äº‹æƒ…"},
      ]),
      endNote: "é è¿‘ä¸æ˜¯è¡¨ç™½ï¼Œæ˜¯èŠ‚å¥å¼€å§‹åŒæ­¥ã€‚",
      nextAfterEnding: "THE_END",
      progress: 100,
    },

    S3_END_B3: {
      scene: 3, ending: true,
      endTitle: "ç»“å±€ B3 Â· æƒé‡ä¸‹è°ƒ",
      endBody: () => renderSystemPanel([
        "ä½ ç»§ç»­æ´—æ¾¡\næ²¡æœ‰å›å¥¹",
        "ç­‰ä½ å‡ºæ¥çš„æ—¶å€™\nå¥¹å·²ç»å‘äº†å¥½å‡ æ¡æ¶ˆæ¯",
        {muted:"è¯­æ°”ä¾æ—§çƒ­æƒ…\næ²¡æœ‰ä¸æ»¡"},
        {danger:"åªæ˜¯ä»é‚£ä¹‹å\nå½“å¥¹åœ¨å¿™çš„æ—¶å€™\nå¥¹ä¼šä¸‹æ„è¯†å±è”½ä½ çš„æ¶ˆæ¯"},
        {muted:"ç›´åˆ°å¿™å®Œ\næ‰å›å¤ä½ "},
      ]),
      endNote: "çƒ­æƒ…ä»åœ¨ï¼Œä½†ä½ çš„æ¶ˆæ¯ä¸å†ä¼˜å…ˆã€‚",
      nextAfterEnding: "THE_END",
      progress: 100,
    },

    THE_END: {
      scene: 4,
      title: "Chapter 2 Â· ç»“æŸ",
      sub: "ä½ åšçš„æ¯ä¸€æ­¥éƒ½åˆç†ï¼Œä½†ç»“å±€ä¸ç”±é€‰æ‹©ä¿è¯",
      lines: [
        {sys:"[ç³»ç»Ÿæç¤º] æœ¬ç« èŠ‚å·²ç»“æŸ"},
        "ä½ åšçš„æ¯ä¸€ä¸ªé€‰æ‹©\néƒ½å¾ˆåˆç†",
        "åªæ˜¯æœ‰äº›å…³ç³»\nä»ä¸€å¼€å§‹\nå°±ä¸äº¤ç»™é€‰æ‹©æ¥å†³å®š",
      ],
      choices: [
        { key:"â†º", text:"å†ç©ä¸€æ¬¡ï¼ˆä»å¤´ï¼‰", next:"S1_START" },
      ],
      progress: 100,
    },
  };

  /* ========= helpers ========= */
  function setProgress(pct){ $('bar').style.width = `${pct}%`; }

  function setHeader(node){
    $('sceneTitle').textContent = node.title || `Scene ${node.scene}`;
    $('sceneSub').textContent = node.sub || "";
    setProgress(node.progress ?? 0);
  }

  function clearLines(){ $('lines').innerHTML = ""; }

  function vibrate(ms=15){
    try{ if (navigator.vibrate) navigator.vibrate(ms); }catch(_){}
  }

  function wait(ms){ return new Promise(r => setTimeout(r, ms)); }

  function addLine(text, cls=""){
    const div = document.createElement('div');
    div.className = `line ${cls}`.trim();
    div.textContent = text;
    $('lines').appendChild(div);

    requestAnimationFrame(() => {
      div.classList.add('show');
      const dlg = document.querySelector('.card.dialogue');
      dlg.scrollTop = dlg.scrollHeight;
    });
  }

  async function playLines(lines){
    isTyping = true;
    cancelToken.cancelled = false;

    for (const item of lines){
      if (cancelToken.cancelled) break;

      if (typeof item === "string"){
        addLine(item);
        await wait(game.fast ? 0 : 320);
        continue;
      }
      if (item.pause){
        await wait(game.fast ? 0 : item.pause);
      } else if (item.muted){
        addLine(item.muted, "muted");
        await wait(game.fast ? 0 : 320);
      } else if (item.sys){
        addLine(item.sys, "sys");
        await wait(game.fast ? 0 : 320);
      } else if (item.em){
        addLine(item.em, "em");
        await wait(game.fast ? 0 : 320);
      } else if (item.danger){
        addLine(item.danger, "em");
        document.querySelector('.phone').classList.add('shake');
        vibrate(30);
        await wait(420);
        document.querySelector('.phone').classList.remove('shake');
      } else if (item.ok){
        addLine(item.ok, "muted");
        await wait(game.fast ? 0 : 320);
      }
    }

    isTyping = false;
  }

  function escapeHTML(s){
    return String(s)
      .replaceAll("&","&amp;")
      .replaceAll("<","&lt;")
      .replaceAll(">","&gt;")
      .replaceAll('"',"&quot;")
      .replaceAll("'","&#39;");
  }

  function renderChoices(choices){
    const box = $('choices');
    box.innerHTML = "";
    for (const c of choices){
      const btn = document.createElement('button');
      btn.className = "btn";
      btn.innerHTML = `<span class="tag">${escapeHTML(c.key)}</span>${escapeHTML(c.text)}`;
      btn.onclick = () => onChoose(btn, c);
      box.appendChild(btn);
    }
  }

  function lockOtherButtons(activeBtn){
    [...$('choices').querySelectorAll('.btn')].forEach(b => {
      if (b !== activeBtn) b.classList.add('fade');
      else b.classList.add('disabled');
    });
  }

  function showOverlay(title, bodyNode, note){
    $('endTitle').textContent = title || "ç»“å±€";
    const endBody = $('endBody');
    endBody.innerHTML = "";
    endBody.appendChild(bodyNode);
    $('endNote').textContent = note || "";
    $('overlay').classList.add('show');
  }

  function hideOverlay(){ $('overlay').classList.remove('show'); }

  /* ========= ending UI blocks ========= */
  function renderChatFail(){
    const wrap = document.createElement('div');
    wrap.className = "chat";

    const top = document.createElement('div');
    top.className = "chatTop";
    top.innerHTML = `<span class="excl"><span class="badgeDanger">!</span> çº¢è‰²æ„Ÿå¹å·</span><span>å‘é€å¤±è´¥</span>`;
    wrap.appendChild(top);

    const them = document.createElement('div');
    them.className = "msg them";
    them.textContent = "æŠ±æ­‰ã€‚";
    wrap.appendChild(them);

    const me = document.createElement('div');
    me.className = "msg me";
    me.textContent = "æ—©å®‰";
    wrap.appendChild(me);

    const sys = document.createElement('div');
    sys.className = "small";
    sys.style.marginTop = "6px";
    sys.style.color = "rgba(255,255,255,.55)";
    sys.textContent = "ç³»ç»Ÿæç¤ºï¼šæ¶ˆæ¯å‘é€å¤±è´¥";
    wrap.appendChild(sys);

    return wrap;
  }

  function renderCallScene(name, lines){
    const card = document.createElement('div');
    card.className = "call";

    const av = document.createElement('div');
    av.className = "avatar";
    av.textContent = "â˜";
    card.appendChild(av);

    const meta = document.createElement('div');
    meta.style.textAlign = "center";
    meta.innerHTML = `<div style="font-weight:750">${escapeHTML(name)}</div><div class="small">é€šè¯ä¸­ <span class="ring"></span></div>`;
    card.appendChild(meta);

    const text = document.createElement('div');
    text.style.width = "100%";
    text.style.display = "grid";
    text.style.gap = "8px";
    text.style.marginTop = "8px";

    lines.forEach(s => {
      const p = document.createElement('div');
      p.className = "msg them";
      p.style.maxWidth = "100%";
      p.style.background = "rgba(255,255,255,.06)";
      p.textContent = String(s);
      text.appendChild(p);
    });

    card.appendChild(text);
    return card;
  }

  function renderSystemPanel(lines){
    const box = document.createElement('div');
    box.style.display = "grid";
    box.style.gap = "10px";

    lines.forEach(item => {
      if (typeof item === "string"){
        const d = document.createElement('div');
        d.className = "msg them";
        d.style.maxWidth = "100%";
        d.style.background = "rgba(255,255,255,.06)";
        d.textContent = item;
        box.appendChild(d);
        return;
      }
      if (item.pause) return;

      const d = document.createElement('div');
      d.className = "msg them";
      d.style.maxWidth = "100%";
      d.style.background = "rgba(255,255,255,.06)";

      if (item.danger){
        d.style.borderColor = "rgba(255,77,79,.35)";
        d.style.background = "rgba(255,77,79,.10)";
        d.textContent = item.danger;
      } else if (item.ok){
        d.style.borderColor = "rgba(52,211,153,.30)";
        d.style.background = "rgba(52,211,153,.10)";
        d.textContent = item.ok;
      } else if (item.muted){
        d.style.opacity = ".86";
        d.textContent = item.muted;
      } else {
        d.textContent = JSON.stringify(item);
      }
      box.appendChild(d);
    });

    return box;
  }

  /* ========= flow ========= */
  async function goto(nodeId){
    game.nodeId = nodeId;
    const node = nodes[nodeId];
    if (!node) return;

    setHeader(node);
    clearLines();
    $('choices').innerHTML = "";

    const dlg = document.querySelector('.card.dialogue');
    dlg.scrollTop = 0;

    if (node.ending){
      await wait(game.fast ? 0 : 160);
      showOverlay(node.endTitle, node.endBody(), node.endNote);
      return;
    }

    await playLines(node.lines || []);
    renderChoices(node.choices || []);
  }

  async function onChoose(btn, choice){
    // âœ… ç‚¹å‡»é€‰é¡¹ä¹Ÿç®—ç”¨æˆ·æ‰‹åŠ¿ï¼šå¦‚æœéŸ³ä¹å·²å¼€ï¼Œé¡ºæ‰‹å°è¯•æ’­æ”¾ï¼ˆæ›´ç¨³ï¼‰
    if (musicEnabled2) tryPlayMusic2();

    if (isTyping) return;
    lockOtherButtons(btn);
    vibrate(18);
    await wait(150);
    await goto(choice.next);
  }

  /* overlay continue */
  $('continueBtn').onclick = async () => {
    if (musicEnabled2) tryPlayMusic2(); // âœ… ç»§ç»­ä¹Ÿè§¦å‘ä¸€æ¬¡
    const node = nodes[game.nodeId];
    hideOverlay();
    await wait(120);
    if (node && node.nextAfterEnding){
      await goto(node.nextAfterEnding);
    }
  };

  /* restart */
  $('restartBtn').onclick = async () => {
    if (musicEnabled2) tryPlayMusic2(); // âœ… é‡æ¥è§¦å‘ä¸€æ¬¡
    game.fast = false;
    $('skipBtn').textContent = "å¿«é€Ÿè·³è¿‡æ–‡å­—";
    hideOverlay();
    await goto("S1_START");
  };

  /* skip typing */
  $('skipBtn').onclick = () => {
    if (musicEnabled2) tryPlayMusic2(); // âœ… è·³è¿‡è§¦å‘ä¸€æ¬¡
    game.fast = !game.fast;
    $('skipBtn').textContent = game.fast ? "æ¢å¤æ­£å¸¸é€Ÿåº¦" : "å¿«é€Ÿè·³è¿‡æ–‡å­—";

    if (isTyping){
      cancelToken.cancelled = true;
      const cur = nodes[game.nodeId];
      if (cur && !cur.ending){
        setTimeout(() => goto(game.nodeId), 0);
      }
    }
  };

  /* start */
  goto("S1_START");
})();
</script>
</body>
</html>
